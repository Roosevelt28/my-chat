<!doctype html>
<html lang="ka">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ChatApp â€”</title>
<style>
:root{
  --bg-dark-1:#071024; --bg-dark-2:#071a2a;
  --panel-dark:rgba(255,255,255,0.02);
  --accent:#06b6d4; --muted:#94a3b8; --text-dark:#e6eef6;
  --radius:12px;
  --reaction-w:320px; --reaction-btn:40px; --reaction-font:20px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,Helvetica;-webkit-font-smoothing:antialiased}
body{background:linear-gradient(180deg,var(--bg-dark-1),var(--bg-dark-2));color:var(--text-dark)}
body.light{background:#fff;color:#0b1220}
.app{display:grid;grid-template-columns:1fr 320px;height:100vh;padding:12px;gap:12px}
.left-col{display:flex;flex-direction:column;border-radius:10px;background:var(--panel-dark);overflow:hidden;min-width:0}
.header-left{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid rgba(255,255,255,0.03)}
body.light .header-left{border-bottom-color:rgba(2,6,23,0.06)}
.brand{font-weight:700;color:var(--accent)}
.online-indicator{font-size:13px;color:var(--muted)}

/* Messages */
.messages{flex:1;padding:12px;overflow:auto;display:flex;flex-direction:column;gap:10px;position:relative;-webkit-overflow-scrolling:touch}
.message{max-width:80%;padding:10px;border-radius:12px; position: relative; z-index:1; word-break:break-word; display:block; box-shadow: 0 6px 18px rgba(2,6,23,0.25);}
.me{align-self:flex-end;background:linear-gradient(90deg,#0ea5a4,#0891b2);color:#042027}
.other{align-self:flex-start;background:rgba(255,255,255,0.03);color:var(--muted)}
body.light .other{background:rgba(2,6,23,0.04);color:#0b1220}
.msg-header{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.msg-header img{width:28px;height:28px;border-radius:50%;object-fit:cover}
.msg-author{font-weight:700;font-size:13px}
.meta{font-size:11px;opacity:0.9;margin-top:6px;text-align:right}

/* Composer */
.composer{display:flex;gap:8px;padding:12px;border-top:1px solid rgba(255,255,255,0.02);align-items:center;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);position:sticky;bottom:0;left:0;right:0;backdrop-filter: blur(6px);z-index:1400;padding-bottom: calc(env(safe-area-inset-bottom) + 12px);}
.left-group{display:flex;gap:8px;align-items:center}
.input{flex:1;min-width:0;padding:12px 14px;border-radius:10px;border:0;background:rgba(255,255,255,0.02);color:inherit;font-size:16px;height:48px;line-height:20px}
body.light .input{background:rgba(2,6,23,0.04);color:#0b1220}
.input::placeholder{color:rgba(230,238,246,0.5)}
.icon-btn{width:44px;height:44px;border-radius:10px;border:0;background:rgba(255,255,255,0.03);display:inline-flex;align-items:center;justify-content:center;color:var(--muted);cursor:pointer}
body.light .icon-btn{background:rgba(2,6,23,0.03);color:#0b1220}
.send-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;background:var(--accent);border:0;border-radius:10px;color:#042027;cursor:pointer;font-weight:700;min-height:44px;min-width:64px;justify-content:center}

/* Users */
.top-controls{display:flex;gap:8px;align-items:center;padding:12px}
.users-list{padding:12px;background:rgba(255,255,255,0.01);border-radius:8px;overflow:auto}
body.light .users-list{background:rgba(2,6,23,0.03)}
.user-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;cursor:pointer}
.user-item img{width:36px;height:36px;border-radius:50%;object-fit:cover;margin-right:8px}
.user-item .name { font-weight:600; }

/* Modal */
.modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:3000}
.modal.hidden{display:none}
.modal .box{background:#071a2a;padding:16px;border-radius:8px;min-width:320px;color:var(--text-dark);position:relative;max-height:calc(100vh - 48px);overflow:auto;width:520px;max-width:calc(100% - 48px)}
body.light .modal .box{background:#fff;color:#0b1220}
.close{position:absolute;right:12px;top:8px;background:transparent;border:0;color:var(--muted);cursor:pointer}
.avatar-large{width:96px;height:96px;border-radius:50%;object-fit:cover}
img.uploaded{max-width:240px;border-radius:8px;display:block;margin-top:8px}
audio.uploaded{display:block;margin-top:8px}

/* Reaction picker (improved) */
.reaction-toggle { background: transparent; border: 1px solid rgba(255,255,255,0.04); padding: 8px 10px; border-radius: 10px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-size: 15px; color: inherit; position: relative; z-index: 2; min-height: 44px; min-width: 44px; }
.reaction-panel { display:flex; gap:8px; align-items:center; padding:6px; border-radius:999px; background: rgba(0,0,0,0.06); position: absolute; z-index:1200; box-shadow: 0 8px 24px rgba(2,6,23,0.4); transform-origin: bottom center; }
.reaction-panel button { background:transparent;border:0;padding:6px;border-radius:8px;font-size:20px;cursor:pointer; width:40px;height:40px; display:flex;align-items:center;justify-content:center; }
.reaction-list { display:flex; gap:6px; align-items:center; margin-top:8px; flex-wrap:wrap; }
.reaction-item { display:inline-flex; align-items:center; gap:6px; padding:6px 8px; border-radius:999px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); cursor:pointer; }
.reaction-item.active { background: rgba(6,182,212,0.12); border-color: rgba(6,182,212,0.18); color: #06b6d4; }

/* Actions & reactions */
.msg-actions { display:flex; gap:8px; align-items:center; margin-top:8px; }
.btn-delete { background: transparent; border: 1px solid rgba(255,255,255,0.04); color: #ffb4b4; padding: 6px 8px; border-radius: 6px; cursor: pointer; font-size: 13px; }

/* Recorder button */
.record-btn { width:48px;height:48px;border-radius:12px;border:0;background:linear-gradient(180deg,#06b6d4,#0284a2);color:#042027;display:inline-flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;transition:transform .08s ease; }
.record-btn.recording { background:linear-gradient(180deg,#ff3b3b,#c40000); box-shadow:0 8px 24px rgba(196,0,0,0.12); transform:scale(1.02); }

/* viewProfile collapse */
#viewProfileModal.view-collapsed .box { max-height:64px; overflow:hidden; transition: max-height 220ms ease; }
#collapseViewBtn.collapsed svg { transform: rotate(180deg); transition: transform 180ms ease; }

/* Mobile adjustments */
@media (max-width:900px) {
  .app{grid-template-columns:1fr; padding:8px; height:100vh}
  .right-col{display:none}
  .messages{padding:10px 6px; gap:8px}
  .message{max-width:92%; padding:10px; border-radius:12px}
  .composer{padding:10px;gap:6px}
  .input{height:52px;padding:12px 12px;font-size:16px;border-radius:12px}
  .icon-btn{width:48px;height:48px;border-radius:12px}
  .send-btn{min-width:56px;padding:10px 12px;border-radius:12px}
  .modal .box{width:calc(100% - 24px);max-height:calc(100vh - 24px);margin:12px}
  .avatar-large{width:72px;height:72px}
  .msg-header img{width:36px;height:36px}
  .reaction-panel{position:fixed; bottom:84px; left:50%; transform:translateX(-50%); }
  .reaction-list{justify-content:center}
  .composer{position:sticky;bottom:0}
}

/* focus */
.reaction-toggle:focus-visible, .reaction-panel button:focus-visible, .icon-btn:focus-visible, .send-btn:focus-visible { outline: 3px solid rgba(6,182,212,0.14); outline-offset: 3px; border-radius: 10px; }

/* subtle pop */
@keyframes pop { from { transform: scale(.96); opacity:0 } to { transform: scale(1); opacity:1 } }
</style>
</head>
<body>
<div class="app" id="appRoot">
  <div class="left-col" role="main" aria-label="áƒ©áƒáƒ¢áƒ˜">
    <div class="header-left">
      <div>
        <div class="brand">ChatApp</div>
        <div class="online-indicator" id="statusText">áƒ’áƒ—áƒ®áƒáƒ•áƒ— áƒ¨áƒ”áƒ®áƒ•áƒ˜áƒ“áƒ”áƒ— áƒáƒœ áƒ“áƒáƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒ˜áƒ áƒ“áƒ”áƒ—</div>
      </div>
      <div id="headerButtons" style="display:flex;gap:8px;align-items:center">
        <button id="themeToggle" class="icon-btn" title="áƒ—áƒ”áƒ›áƒ˜áƒ¡ áƒ’áƒáƒ“áƒáƒ áƒ—áƒ•áƒ" aria-label="áƒ—áƒ”áƒ›áƒ">
          <svg id="themeIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path id="themeMoon" d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" fill="#06b6d4" opacity="0.12"/><path d="M21 12.79A9 9 0 1111.21 3" stroke="#06b6d4" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>

        <button id="loginHeaderBtn" class="icon-btn" title="áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ" aria-label="áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ">
          ğŸ”
        </button>

        <button id="openRegisterBtn" class="icon-btn" title="áƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒáƒªáƒ˜áƒ" aria-label="áƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒáƒªáƒ˜áƒ">
          âœï¸
        </button>

        <button id="openProfileBtn" class="icon-btn" title="áƒáƒ áƒáƒ¤áƒ˜áƒšáƒ˜" aria-label="áƒáƒ áƒáƒ¤áƒ˜áƒšáƒ˜" style="display:none">
          ğŸ‘¤
        </button>

        <button id="logoutBtn" class="icon-btn" title="áƒ’áƒáƒ¡áƒ•áƒšáƒ" aria-label="áƒ’áƒáƒ¡áƒ•áƒšáƒ" style="display:none">
          â‹
        </button>
      </div>
    </div>

    <div class="messages" id="messages" tabindex="0" aria-live="polite"></div>

    <div class="composer" role="region" aria-label="áƒ¨áƒ”áƒ¢áƒ§áƒáƒ‘áƒ˜áƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒ›áƒ¥áƒ›áƒœáƒ”áƒšáƒ˜">
      <div class="left-group">
        <label class="file-label" title="áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ">
          <input id="fileInput" type="file" accept="image/*,audio/*" style="display:none" />
          <button id="attachBtn" class="icon-btn" aria-label="áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ" title="áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ">ğŸ“</button>
        </label>

        <!-- Emoji quick-insert removed per request -->

        <button id="recordBtn" class="record-btn" title="áƒ©áƒáƒ¬áƒ”áƒ áƒ” áƒ®áƒ›áƒáƒ•áƒáƒœáƒ˜" aria-pressed="false" aria-label="áƒ©áƒáƒ¬áƒ”áƒ áƒ">
          ğŸ¤
        </button>
      </div>

      <input id="composerInput" class="input" type="text" placeholder="áƒ“áƒáƒ¬áƒ”áƒ áƒ”áƒ— áƒ¨áƒ”áƒ¢áƒ§áƒáƒ‘áƒ˜áƒœáƒ”áƒ‘áƒ..." aria-label="áƒ¨áƒ”áƒ¢áƒ§áƒáƒ‘áƒ˜áƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒ¢áƒ”áƒ¥áƒ¡áƒ¢áƒ˜" />
      <button id="sendBtn" class="send-btn" aria-label="áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ">áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ</button>
    </div>
  </div>

  <aside class="right-col" aria-label="áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒšáƒ”áƒ‘áƒ˜">
    <div class="top-controls">
      <input id="searchUsers" type="search" placeholder="áƒ«áƒ˜áƒ”áƒ‘áƒ" style="flex:1;padding:8px;border-radius:8px;border:0;background:rgba(255,255,255,0.01);color:inherit" />
      <button id="openRegisterBtn2" class="icon-btn" aria-label="áƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒáƒªáƒ˜áƒ" title="áƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒáƒªáƒ˜áƒ">âœï¸</button>
    </div>
    <div class="users-list" id="usersList" aria-label="áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒšáƒ”áƒ‘áƒ˜"></div>
  </aside>
</div>

<!-- Profile modal (current user) -->
<div class="modal hidden" id="profileModal" role="dialog" aria-modal="true" aria-labelledby="profileTitle">
  <div class="box" tabindex="0">
    <button class="close" id="closeProfile" aria-label="áƒ“áƒáƒ®áƒ£áƒ áƒ•áƒ">âœ•</button>
    <h3 id="profileTitle">áƒáƒ áƒáƒ¤áƒ˜áƒšáƒ˜</h3>
    <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
      <img id="profileAvatar" class="avatar-large" src="https://picsum.photos/96" alt="áƒáƒ áƒáƒ¤áƒ˜áƒšáƒ˜" />
      <div>
        <div id="profileFullName" style="font-weight:700">áƒ¡áƒáƒ®áƒ”áƒšáƒ˜ áƒ’áƒ•áƒáƒ áƒ˜</div>
        <div id="profileNickname" style="color:var(--muted);margin-top:6px">@áƒœáƒ˜áƒ™áƒœáƒ”áƒ˜áƒ›áƒ˜</div>
      </div>
    </div>
    <div class="small" style="margin-top:12px">áƒ“áƒáƒ‘. áƒ¬áƒ”áƒšáƒ˜: <span id="profileYear">----</span> â€¢ áƒáƒ¡áƒáƒ™áƒ˜: <span id="profileAge">--</span></div>
    <div style="margin-top:12px;display:flex;gap:8px">
      <label style="display:inline-flex;align-items:center;gap:8px">
        <input id="avatarUploadInput" type="file" accept="image/*" style="display:none" />
        <button id="changeAvatarBtn" class="send-btn">áƒáƒ•áƒáƒ¢áƒáƒ áƒ˜áƒ¡ áƒ¨áƒ”áƒªáƒ•áƒšáƒ</button>
      </label>
      <button id="editProfileBtn" class="icon-btn">âœ</button>
      <button id="closeProfileBtn" class="send-btn">áƒ“áƒáƒ®áƒ£áƒ áƒ•áƒ</button>
    </div>
  </div>
</div>

<!-- Register modal -->
<div class="modal hidden" id="registerModal" role="dialog" aria-modal="true" aria-labelledby="registerTitle">
  <div class="box" tabindex="0">
    <button class="close" id="closeRegister" aria-label="áƒ“áƒáƒ®áƒ£áƒ áƒ•áƒ">âœ•</button>
    <h3 id="registerTitle">áƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒáƒªáƒ˜áƒ</h3>
    <form id="registerForm" style="margin-top:12px;display:flex;flex-direction:column;gap:8px">
      <label style="display:flex;flex-direction:column;gap:6px"><span class="small">áƒ¡áƒáƒ®áƒ”áƒšáƒ˜</span><input id="regFirst" type="text" required style="padding:8px;border-radius:8px;border:0;background:rgba(255,255,255,0.02);color:inherit" /></label>
      <label style="display:flex;flex-direction:column;gap:6px"><span class="small">áƒ’áƒ•áƒáƒ áƒ˜</span><input id="regLast" type="text" required style="padding:8px;border-radius:8px;border:0;background:rgba(255,255,255,0.02);color:inherit" /></label>
      <div style="display:flex;gap:8px">
        <label style="flex:1;display:flex;flex-direction:column;gap:6px"><span class="small">áƒ“áƒáƒ‘. áƒ¬áƒ”áƒšáƒ˜</span><input id="regYear" type="number" min="1900" max="2025" required style="padding:8px;border-radius:8px;border:0;background:rgba(255,255,255,0.02);color:inherit" /></label>
        <label style="flex:1;display:flex;flex-direction:column;gap:6px"><span class="small">áƒœáƒ˜áƒ™ áƒœáƒ”áƒ˜áƒ›áƒ˜</span><input id="regNick" type="text" required style="padding:8px;border-radius:8px;border:0;background:rgba(255,255,255,0.02);color:inherit" /></label>
      </div>
      <div style="display:flex;gap:8px">
        <label style="flex:1;display:flex;flex-direction:column;gap:6px"><span class="small">áƒáƒáƒ áƒáƒšáƒ˜</span><input id="regPass" type="password" minlength="6" required style="padding:8px;border-radius:8px;border:0;background:rgba(255,255,255,0.02);color:inherit" /></label>
        <label style="flex:1;display:flex;flex-direction:column;gap:6px"><span class="small">áƒ’áƒáƒ˜áƒ›áƒ”áƒáƒ áƒ”áƒ—</span><input id="regPassConfirm" type="password" minlength="6" required style="padding:8px;border-radius:8px;border:0;background:rgba(255,255,255,0.02);color:inherit" /></label>
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
        <input id="regAvatarInput" type="file" accept="image/*" style="display:none" />
        <button type="button" id="regAvatarBtn" class="icon-btn">ğŸ“·</button>
        <div id="regAvatarPreview" class="small">áƒáƒ•áƒáƒ¢áƒáƒ áƒ˜ (áƒáƒ áƒáƒ¡áƒáƒ•áƒáƒšáƒ“áƒ”áƒ‘áƒ£áƒšáƒ)</div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px;justify-content:flex-end">
        <button type="submit" class="send-btn">áƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒáƒªáƒ˜áƒ</button>
        <button type="button" id="openLoginFromRegisterBtn" class="icon-btn" title="áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ">ğŸ”</button>
      </div>
    </form>
  </div>
</div>

<!-- Login modal -->
<div class="modal hidden" id="loginModal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
  <div class="box" tabindex="0">
    <button class="close" id="closeLogin" aria-label="áƒ“áƒáƒ®áƒ£áƒ áƒ•áƒ">âœ•</button>
    <h3 id="loginTitle">áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ</h3>
    <form id="loginForm" style="margin-top:12px;display:flex;flex-direction:column;gap:8px">
      <label style="display:flex;flex-direction:column;gap:6px"><span class="small">áƒœáƒ˜áƒ™ áƒœáƒ”áƒ˜áƒ›áƒ˜</span><input id="loginNick" type="text" required style="padding:8px;border-radius:8px;border:0;background:rgba(255,255,255,0.02);color:inherit" /></label>
      <label style="display:flex;flex-direction:column;gap:6px"><span class="small">áƒáƒáƒ áƒáƒšáƒ˜</span><input id="loginPass" type="password" required style="padding:8px;border-radius:8px;border:0;background:rgba(255,255,255,0.02);color:inherit" /></label>
      <div style="display:flex;gap:8px;margin-top:8px;justify-content:flex-end">
        <button type="submit" class="send-btn">áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ</button>
        <button type="button" id="openRegisterFromLoginBtn" class="icon-btn">âœï¸</button>
      </div>
    </form>
  </div>
</div>

<!-- View other user's profile modal (with collapse button) -->
<div class="modal hidden" id="viewProfileModal" role="dialog" aria-modal="true" aria-labelledby="viewProfileTitle">
  <div class="box" tabindex="0">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div style="display:flex;align-items:center;gap:12px">
        <h3 id="viewProfileTitle" style="margin:0">áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒšáƒ˜áƒ¡ áƒáƒ áƒáƒ¤áƒ˜áƒšáƒ˜</h3>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <button id="collapseViewBtn" class="icon-btn" title="áƒ©áƒáƒ™áƒ”áƒªáƒ•áƒ" aria-label="áƒ©áƒáƒ™áƒ”áƒªáƒ•áƒ" style="margin-right:6px">
          â¤¢
        </button>
        <button class="close" id="closeViewProfile" aria-label="áƒ“áƒáƒ®áƒ£áƒ áƒ•áƒ">âœ•</button>
      </div>
    </div>

    <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
      <img id="viewAvatar" class="avatar-large" src="https://picsum.photos/96" alt="áƒáƒ•áƒáƒ¢áƒáƒ áƒ˜" />
      <div>
        <div id="viewFullName" style="font-weight:700">áƒ¡áƒáƒ®áƒ”áƒšáƒ˜ áƒ’áƒ•áƒáƒ áƒ˜</div>
        <div id="viewNickname" style="color:var(--muted);margin-top:6px">@áƒœáƒ˜áƒ™áƒœáƒ”áƒ˜áƒ›áƒ˜</div>
      </div>
    </div>
    <div class="small" style="margin-top:12px">áƒ“áƒáƒ‘. áƒ¬áƒ”áƒšáƒ˜: <span id="viewYear">----</span> â€¢ áƒáƒ¡áƒáƒ™áƒ˜: <span id="viewAge">--</span></div>
  </div>
</div>

<!-- Reaction panel placeholder (will be positioned near message) -->
<div id="reactionPanel" class="reaction-panel" style="display:none;">
  <!-- buttons inserted dynamically -->
</div>

<script>
/* Final JS: reaction toggle improved, emoji removed from composer, theme toggle fixed, profile shows birth year + age, mobile tweaks */
(async function(){
  const $ = id => document.getElementById(id);

  // Elements
  const messagesEl = $('messages');
  const usersListEl = $('usersList');
  const composerInput = $('composerInput');
  const sendBtn = $('sendBtn');
  const attachBtn = $('attachBtn');
  const fileInput = $('fileInput');
  const recordBtn = $('recordBtn');
  const reactionPanel = $('reactionPanel');

  const loginHeaderBtn = $('loginHeaderBtn');
  const openRegisterBtn = $('openRegisterBtn');
  const openRegisterBtn2 = $('openRegisterBtn2');
  const openProfileBtn = $('openProfileBtn');
  const logoutBtn = $('logoutBtn');
  const statusText = $('statusText');
  const themeToggle = $('themeToggle');
  const themeIcon = $('themeIcon');

  const profileModal = $('profileModal');
  const closeProfile = $('closeProfile');
  const closeProfileBtn = $('closeProfileBtn');
  const changeAvatarBtn = $('changeAvatarBtn');
  const avatarUploadInput = $('avatarUploadInput');
  const editProfileBtn = $('editProfileBtn');

  const registerModal = $('registerModal');
  const registerForm = $('registerForm');
  const regFirst = $('regFirst');
  const regLast = $('regLast');
  const regYear = $('regYear');
  const regNick = $('regNick');
  const regPass = $('regPass');
  const regPassConfirm = $('regPassConfirm');
  const regAvatarBtn = $('regAvatarBtn');
  const regAvatarInput = $('regAvatarInput');
  const regAvatarPreview = $('regAvatarPreview');
  const openLoginFromRegisterBtn = $('openLoginFromRegisterBtn');

  const loginModal = $('loginModal');
  const loginForm = $('loginForm');
  const loginNick = $('loginNick');
  const loginPass = $('loginPass');

  const viewProfileModal = $('viewProfileModal');
  const closeViewProfile = $('closeViewProfile');
  const collapseViewBtn = $('collapseViewBtn');
  const viewAvatar = $('viewAvatar');
  const viewFullName = $('viewFullName');
  const viewNickname = $('viewNickname');
  const viewYear = $('viewYear');
  const viewAge = $('viewAge');

  // Storage keys
  const LS_USERS = 'chatapp_users_final_v2';
  const LS_CURRENT = 'chatapp_current_final_v2';
  const LS_MESSAGES = 'chatapp_messages_final_v2';
  const LS_THEME = 'chatapp_theme_final_v2';

  // State
  let users = safeLoad(LS_USERS) || [];
  let currentUser = safeLoad(LS_CURRENT) || null;
  let messages = safeLoad(LS_MESSAGES) || [];

  let pendingFile = null;
  let pendingPreviewEl = null;

  // Recorder
  let mediaRecorder = null;
  let mediaStream = null;
  let recordingChunks = [];
  let isRecording = false;

  // Reaction set (default quick set)
  const QUICK_REACTIONS = ['ğŸ‘','â¤ï¸','ğŸ˜‚','ğŸ˜®','ğŸ˜¢','ğŸ”¥','ğŸ¤©'];

  // Helpers
  function safeLoad(key){ try { return JSON.parse(localStorage.getItem(key)); } catch(e){ return null; } }
  function safeSave(key, val){ try { localStorage.setItem(key, JSON.stringify(val)); } catch(e){} }
  function uid(prefix='id'){ return prefix + '_' + Date.now().toString(36) + Math.random().toString(36).slice(2,6); }
  function timeNow(){ const d=new Date(); return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  async function sha256Hex(str){ try { const enc = new TextEncoder(); const data = enc.encode(str); const hash = await crypto.subtle.digest('SHA-256', data); return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join(''); } catch(e){ return null; } }

  // Init demo
  function initDemo(){
    if(!Array.isArray(users) || users.length === 0){
      users = [
        { id: 'u_demo1', first:'áƒáƒœáƒ', last:'áƒ›áƒªáƒ˜áƒ áƒ˜áƒ¨áƒ•áƒ˜áƒšáƒ˜', year:1992, nick:'ana92', avatar:'https://picsum.photos/seed/ana/96', passHash:null },
        { id: 'u_demo2', first:'áƒ’áƒ˜áƒáƒ áƒ’áƒ˜', last:'áƒ™áƒáƒáƒáƒœáƒáƒ«áƒ”', year:1988, nick:'giorgi88', avatar:'https://picsum.photos/seed/giorgi/96', passHash:null }
      ];
      safeSave(LS_USERS, users);
    }
    if(!Array.isArray(messages) || messages.length === 0){
      messages = [
        { id: uid('m'), text:'áƒ’áƒáƒ›áƒáƒ áƒ¯áƒáƒ‘áƒ! áƒ”áƒ¡ áƒáƒ áƒ˜áƒ¡ áƒ“áƒ”áƒ›áƒ áƒ›áƒ”áƒ¡áƒ˜áƒ¯áƒ˜.', userId: users[0].id, time: timeNow(), reactions:[], reactionCount:0 },
        { id: uid('m'), text:'áƒ™áƒáƒ áƒ’áƒáƒ“, áƒ›áƒáƒ“áƒšáƒáƒ‘áƒ!', userId: users[1].id, time: timeNow(), reactions:[], reactionCount:0 }
      ];
      safeSave(LS_MESSAGES, messages);
    }
  }

  // Render users
  function renderUsers(){
    if(!usersListEl) return;
    usersListEl.innerHTML = '';
    users.forEach(u=>{
      const item = document.createElement('div');
      item.className = 'user-item';
      const isMe = currentUser && currentUser.id === u.id;
      item.innerHTML = `<div style="display:flex;align-items:center"><img src="${u.avatar||'https://picsum.photos/36'}" alt="" style="width:36px;height:36px;border-radius:50%"/><div style="margin-left:8px"><strong>${escapeHtml(u.first)} ${escapeHtml(u.last)}</strong><div class="small">@${escapeHtml(u.nick)}</div></div></div><div>${isMe?'<span class="small">áƒ›áƒ”</span>':'<button class="icon-btn view-profile-btn" data-id="'+u.id+'" title="áƒœáƒáƒ®áƒ•áƒ">ğŸ‘ï¸</button>'}</div>`;
      usersListEl.appendChild(item);
    });
  }

  // Render messages (with reaction list)
  function renderMessages(){
    if(!messagesEl) return;
    messagesEl.innerHTML = '';
    messages.forEach(m=>{
      const author = users.find(u=>u.id===m.userId) || {nick:'unknown', first:'', last:'', avatar:'https://picsum.photos/36'};
      const el = document.createElement('div');
      el.className = 'message ' + (currentUser && currentUser.id===m.userId ? 'me' : 'other');
      el.dataset.id = m.id;

      const header = document.createElement('div'); header.className='msg-header';
      const avatar = document.createElement('img'); avatar.src = author.avatar || 'https://picsum.photos/36'; avatar.alt = author.nick;
      header.appendChild(avatar);
      const name = document.createElement('div'); name.innerHTML = `<div class="msg-author">${escapeHtml(author.first)} ${escapeHtml(author.last)} <span style="font-weight:600;color:var(--muted);font-size:12px">(@${escapeHtml(author.nick)})</span></div>`;
      header.appendChild(name);
      el.appendChild(header);

      const content = document.createElement('div'); content.innerHTML = escapeHtml(m.text || '').replace(/\n/g,'<br>');
      el.appendChild(content);

      if(m.file){
        if(m.file.type && m.file.type.startsWith('image/')){
          const img = document.createElement('img'); img.className='uploaded'; img.src = m.file.data; img.style.maxWidth='220px'; img.style.marginTop='8px'; el.appendChild(img);
        } else if(m.file.type && m.file.type.startsWith('audio/')){
          const audio = document.createElement('audio'); audio.className='uploaded'; audio.controls=true; audio.src = m.file.data; audio.style.marginTop='8px'; el.appendChild(audio);
        } else {
          const link = document.createElement('div'); link.textContent = m.file.name || 'áƒ¤áƒáƒ˜áƒšáƒ˜'; link.style.marginTop='8px'; link.className='small'; el.appendChild(link);
        }
      }

      // reactions display
      const reactionList = document.createElement('div'); reactionList.className = 'reaction-list';
      (m.reactions || []).forEach(r=>{
        const item = document.createElement('div');
        item.className = 'reaction-item' + ((r.users || []).includes(currentUser ? currentUser.id : '') ? ' active' : '');
        item.dataset.emoji = r.emoji;
        item.innerHTML = `${escapeHtml(r.emoji)} <span class="small">${r.count}</span>`;
        // clicking a reaction toggles current user's reaction for that emoji
        item.addEventListener('click', (ev)=>{
          ev.stopPropagation();
          toggleReaction(m.id, r.emoji);
        });
        reactionList.appendChild(item);
      });

      // reaction toggle button (opens panel)
      const actions = document.createElement('div'); actions.className='msg-actions';
      const toggle = document.createElement('button'); toggle.className='reaction-toggle'; toggle.setAttribute('aria-expanded','false'); toggle.textContent='ğŸ™‚';
      toggle.addEventListener('click', (ev)=> {
        ev.stopPropagation();
        openReactionPanelForMessage(el, m.id);
      });
      actions.appendChild(toggle);
      actions.appendChild(reactionList);

      // delete if owner
      if(currentUser && m.userId === currentUser.id){
        const del = document.createElement('button'); del.className='btn-delete'; del.textContent='áƒ¬áƒáƒ¨áƒšáƒ';
        del.addEventListener('click', ()=>{ if(confirm('áƒœáƒáƒ›áƒ“áƒ•áƒ˜áƒšáƒáƒ“ áƒ¬áƒáƒ¨áƒšáƒ?')){ messages = messages.filter(x=>x.id!==m.id); safeSave(LS_MESSAGES, messages); renderMessages(); }});
        actions.appendChild(del);
      }

      el.appendChild(actions);
      messagesEl.appendChild(el);
    });
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // Reaction logic: messages[].reactions = [{emoji, count, users: [userIds]}]
  function ensureReactionStructure(msg){
    if(!msg.reactions) msg.reactions = [];
    msg.reactions.forEach(r => { if(!Array.isArray(r.users)) r.users = []; if(typeof r.count !== 'number') r.count = r.users.length; });
  }

  function toggleReaction(messageId, emoji){
    if(!currentUser) { alert('áƒ áƒ”áƒáƒ¥áƒªáƒ˜áƒ˜áƒ¡ áƒ“áƒáƒ¡áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒšáƒáƒ“ áƒ¡áƒáƒ­áƒ˜áƒ áƒáƒ áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ'); return; }
    const msg = messages.find(m => m.id === messageId);
    if(!msg) return;
    ensureReactionStructure(msg);
    let r = msg.reactions.find(x => x.emoji === emoji);
    if(!r){
      r = { emoji, count: 0, users: [] };
      msg.reactions.push(r);
    }
    const idx = r.users.indexOf(currentUser.id);
    if(idx === -1){
      r.users.push(currentUser.id);
      r.count = (r.count || 0) + 1;
    } else {
      r.users.splice(idx,1);
      r.count = Math.max(0, (r.count || 1) - 1);
      if(r.count === 0) msg.reactions = msg.reactions.filter(x => x.emoji !== emoji);
    }
    msg.reactionCount = (msg.reactions || []).reduce((s,x)=>s + (x.count||0), 0);
    safeSave(LS_MESSAGES, messages);
    renderMessages();
  }

  // Open reaction panel near message element
  function openReactionPanelForMessage(messageEl, messageId){
    if(!reactionPanel) return;
    // build buttons
    reactionPanel.innerHTML = '';
    QUICK_REACTIONS.forEach(emoji => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = emoji;
      btn.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        toggleReaction(messageId, emoji);
        closeReactionPanel();
      });
      reactionPanel.appendChild(btn);
    });
    // position
    const rect = messageEl.getBoundingClientRect();
    const panelW = Math.min(320, window.innerWidth - 24);
    reactionPanel.style.width = panelW + 'px';
    reactionPanel.style.display = 'flex';
    // prefer above message if space, else below
    const aboveTop = rect.top - 56;
    if(aboveTop > 80){
      reactionPanel.style.left = Math.max(8, rect.left + rect.width/2 - panelW/2) + 'px';
      reactionPanel.style.top = (rect.top - 56) + 'px';
    } else {
      reactionPanel.style.left = Math.max(8, rect.left + rect.width/2 - panelW/2) + 'px';
      reactionPanel.style.top = (rect.bottom + 8) + 'px';
    }
    // close on outside click
    setTimeout(()=>{ document.addEventListener('click', outsideReactionClick); }, 10);
  }

  function closeReactionPanel(){
    if(!reactionPanel) return;
    reactionPanel.style.display = 'none';
    reactionPanel.innerHTML = '';
    document.removeEventListener('click', outsideReactionClick);
  }
  function outsideReactionClick(e){
    if(!reactionPanel) return;
    if(!reactionPanel.contains(e.target)) closeReactionPanel();
  }

  // Open/close modals
  function openModal(modal){ if(!modal) return; modal.classList.remove('hidden'); const box = modal.querySelector('.box'); if(box) box.focus(); }
  function closeModal(modal){ if(!modal) return; modal.classList.add('hidden'); }

  // Registration
  if(regAvatarBtn && regAvatarInput){
    regAvatarBtn.addEventListener('click', ()=> regAvatarInput.click());
    regAvatarInput.addEventListener('change', (e)=> {
      const f = e.target.files && e.target.files[0]; if(!f) return;
      const r = new FileReader(); r.onload = ()=> { regAvatarPreview.textContent = f.name; regAvatarPreview.style.backgroundImage = `url(${r.result})`; regAvatarPreview.style.backgroundSize='cover'; regAvatarPreview.style.padding='8px'; regAvatarPreview.style.borderRadius='8px'; };
      r.readAsDataURL(f);
    });
  }

  if(registerForm){
    registerForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const first = regFirst.value.trim(), last = regLast.value.trim(), year = parseInt(regYear.value,10), nick = regNick.value.trim();
      const pass = regPass.value, passC = regPassConfirm.value;
      if(!first||!last||!year||!nick||!pass||!passC){ alert('áƒ’áƒ—áƒ®áƒáƒ•áƒ— áƒ¨áƒ”áƒáƒ•áƒ¡áƒáƒ— áƒ§áƒ•áƒ”áƒšáƒ áƒ•áƒ”áƒšáƒ˜'); return; }
      if(pass !== passC){ alert('áƒáƒáƒ áƒáƒšáƒ”áƒ‘áƒ˜ áƒáƒ  áƒ”áƒ›áƒ—áƒ®áƒ•áƒ”áƒ•áƒ'); return; }
      if(pass.length < 6){ alert('áƒáƒáƒ áƒáƒšáƒ˜ áƒ£áƒœáƒ“áƒ áƒ˜áƒ§áƒáƒ¡ áƒ›áƒ˜áƒœáƒ˜áƒ›áƒ£áƒ› 6 áƒ¡áƒ˜áƒ›áƒ‘áƒáƒšáƒ'); return; }
      if(users.some(u=>u.nick.toLowerCase()===nick.toLowerCase())){ alert('áƒœáƒ˜áƒ™áƒ˜ áƒ“áƒáƒ™áƒáƒ•áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ'); return; }
      const passHash = await sha256Hex(pass);
      const newUser = { id: uid('u'), first, last, year, nick, avatar:null, passHash };
      const f = regAvatarInput.files && regAvatarInput.files[0];
      if(f){
        const r = new FileReader(); r.onload = ()=> { newUser.avatar = r.result; users.push(newUser); safeSave(LS_USERS, users); currentUser = newUser; safeSave(LS_CURRENT, currentUser); closeModal(registerModal); updateAuthUI(); renderUsers(); renderMessages(); };
        r.readAsDataURL(f);
      } else {
        users.push(newUser); safeSave(LS_USERS, users); currentUser = newUser; safeSave(LS_CURRENT, currentUser); closeModal(registerModal); updateAuthUI(); renderUsers(); renderMessages();
      }
    });
  }

  // Login
  if(loginForm){
    loginForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const nick = loginNick.value.trim(), pass = loginPass.value;
      if(!nick||!pass){ alert('áƒ¨áƒ”áƒ˜áƒ§áƒ•áƒáƒœáƒ”áƒ— áƒœáƒ˜áƒ™áƒ˜ áƒ“áƒ áƒáƒáƒ áƒáƒšáƒ˜'); return; }
      const user = users.find(u=>u.nick.toLowerCase()===nick.toLowerCase());
      if(!user){ alert('áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ˜ áƒ•áƒ”áƒ  áƒ›áƒáƒ˜áƒ«áƒ”áƒ‘áƒœáƒ'); return; }
      if(!user.passHash){ alert('áƒáƒ› áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ¡ áƒáƒáƒ áƒáƒšáƒ˜ áƒáƒ  áƒáƒ¥áƒ•áƒ¡'); return; }
      const h = await sha256Hex(pass);
      if(h !== user.passHash){ alert('áƒáƒáƒ áƒáƒšáƒ˜ áƒáƒ áƒáƒ¡áƒ¬áƒáƒ áƒ˜áƒ'); return; }
      currentUser = user; safeSave(LS_CURRENT, currentUser); closeModal(loginModal); updateAuthUI(); renderUsers(); renderMessages();
    });
  }

  // Header buttons
  if(loginHeaderBtn) loginHeaderBtn.addEventListener('click', ()=> openModal(loginModal));
  if(openRegisterBtn) openRegisterBtn.addEventListener('click', ()=> openModal(registerModal));
  if(openRegisterBtn2) openRegisterBtn2.addEventListener('click', ()=> openModal(registerModal));
  if(openLoginFromRegisterBtn) openLoginFromRegisterBtn.addEventListener('click', ()=> { closeModal(registerModal); openModal(loginModal); });
  if($('openRegisterFromLoginBtn')) $('openRegisterFromLoginBtn').addEventListener('click', ()=> { closeModal(loginModal); openModal(registerModal); });

  if(logoutBtn) logoutBtn.addEventListener('click', ()=> { if(!currentUser){ alert('áƒáƒ  áƒ®áƒáƒ áƒ— áƒ¨áƒ”áƒ¡áƒ£áƒšáƒ˜'); return; } if(!confirm('áƒœáƒáƒ›áƒ“áƒ•áƒ˜áƒšáƒáƒ“ áƒ’áƒ¡áƒ£áƒ áƒ— áƒ’áƒáƒ¡áƒ•áƒšáƒ?')) return; currentUser=null; safeSave(LS_CURRENT, currentUser); updateAuthUI(); renderUsers(); renderMessages(); });

  // Profile modal (current user)
  if(openProfileBtn) openProfileBtn.addEventListener('click', ()=> { if(!currentUser){ alert('áƒ’áƒ—áƒ®áƒáƒ•áƒ— áƒ¨áƒ”áƒ®áƒ•áƒ˜áƒ“áƒ”áƒ— áƒáƒœ áƒ“áƒáƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒ˜áƒ áƒ“áƒ”áƒ—'); return; } showCurrentProfile(); openModal(profileModal); });
  if(closeProfile) closeProfile.addEventListener('click', ()=> closeModal(profileModal));
  if(closeProfileBtn) closeProfileBtn.addEventListener('click', ()=> closeModal(profileModal));
  if(profileModal) profileModal.addEventListener('click', (e)=> { if(e.target === profileModal) closeModal(profileModal); });

  function showCurrentProfile(){
    if(!currentUser) return;
    $('profileAvatar').src = currentUser.avatar || 'https://picsum.photos/96';
    $('profileFullName').textContent = `${currentUser.first} ${currentUser.last}`;
    $('profileNickname').textContent = `@${currentUser.nick}`;
    $('profileYear').textContent = currentUser.year || '----';
    $('profileAge').textContent = computeAge(currentUser.year);
  }

  if(changeAvatarBtn && avatarUploadInput){
    changeAvatarBtn.addEventListener('click', ()=> avatarUploadInput.click());
    avatarUploadInput.addEventListener('change', (e)=> {
      const f = e.target.files && e.target.files[0]; if(!f || !currentUser) return;
      const r = new FileReader(); r.onload = ()=> { currentUser.avatar = r.result; const idx = users.findIndex(u=>u.id===currentUser.id); if(idx>=0) users[idx].avatar = currentUser.avatar; safeSave(LS_USERS, users); safeSave(LS_CURRENT, currentUser); showCurrentProfile(); renderUsers(); renderMessages(); };
      r.readAsDataURL(f);
    });
  }

  if(editProfileBtn){
    editProfileBtn.addEventListener('click', ()=> {
      if(!currentUser) return;
      const newFirst = prompt('áƒ¡áƒáƒ®áƒ”áƒšáƒ˜', currentUser.first) || currentUser.first;
      const newLast = prompt('áƒ’áƒ•áƒáƒ áƒ˜', currentUser.last) || currentUser.last;
      const newYear = parseInt(prompt('áƒ“áƒáƒ‘áƒáƒ“áƒ”áƒ‘áƒ˜áƒ¡ áƒ¬áƒ”áƒšáƒ˜', currentUser.year) || currentUser.year,10) || currentUser.year;
      const newNick = prompt('áƒœáƒ˜áƒ™ áƒœáƒ”áƒ˜áƒ›áƒ˜', currentUser.nick) || currentUser.nick;
      if(newNick !== currentUser.nick && users.some(u => u.nick.toLowerCase() === newNick.toLowerCase())){ alert('áƒ”áƒ¡ áƒœáƒ˜áƒ™áƒœáƒ”áƒ˜áƒ›áƒ˜ áƒ“áƒáƒ™áƒáƒ•áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ'); return; }
      currentUser.first = newFirst; currentUser.last = newLast; currentUser.year = newYear; currentUser.nick = newNick;
      const idx = users.findIndex(u => u.id === currentUser.id); if(idx >= 0) users[idx] = currentUser;
      safeSave(LS_USERS, users); safeSave(LS_CURRENT, currentUser); showCurrentProfile(); renderUsers(); renderMessages();
    });
  }

  // View other user's profile
  if(usersListEl){
    usersListEl.addEventListener('click', (e)=>{
      const btn = e.target.closest('.view-profile-btn') || e.target.closest('.view-btn');
      if(!btn) return;
      const uid = btn.dataset.user || btn.dataset.id;
      const u = users.find(x => x.id === uid);
      if(!u) return;
      viewAvatar.src = u.avatar || 'https://picsum.photos/96';
      viewFullName.textContent = `${u.first} ${u.last}`;
      viewNickname.textContent = `@${u.nick}`;
      viewYear.textContent = u.year || '----';
      viewAge.textContent = computeAge(u.year);
      if(viewProfileModal) viewProfileModal.classList.remove('view-collapsed');
      if(collapseViewBtn) collapseViewBtn.classList.remove('collapsed');
      openModal(viewProfileModal);
    });
  }

  // Close view profile and reset collapse state
  if(closeViewProfile){
    closeViewProfile.addEventListener('click', ()=> { if(viewProfileModal) viewProfileModal.classList.remove('view-collapsed'); if(collapseViewBtn) collapseViewBtn.classList.remove('collapsed'); closeModal(viewProfileModal); });
  }
  if(viewProfileModal){
    viewProfileModal.addEventListener('click', (e)=> { if(e.target === viewProfileModal){ viewProfileModal.classList.remove('view-collapsed'); if(collapseViewBtn) collapseViewBtn.classList.remove('collapsed'); closeModal(viewProfileModal); }});
  }

  // Collapse / expand view profile
  if(collapseViewBtn && viewProfileModal){
    collapseViewBtn.addEventListener('click', ()=> {
      const isCollapsed = collapseViewBtn.classList.toggle('collapsed');
      if(isCollapsed) viewProfileModal.classList.add('view-collapsed');
      else viewProfileModal.classList.remove('view-collapsed');
    });
  }

  // Attach preview
  if(attachBtn && fileInput){
    attachBtn.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', (e)=>{
      const f = e.target.files && e.target.files[0]; if(!f) return;
      pendingFile = f;
      if(pendingPreviewEl && pendingPreviewEl.parentNode) pendingPreviewEl.parentNode.removeChild(pendingPreviewEl);
      const preview = document.createElement('div'); preview.style.display='flex'; preview.style.alignItems='center'; preview.style.gap='8px'; preview.style.marginLeft='8px'; preview.style.padding='6px'; preview.style.borderRadius='8px'; preview.style.background='rgba(255,255,255,0.02)';
      const name = document.createElement('div'); name.className='small'; name.textContent = f.name; preview.appendChild(name);
      if(f.type.startsWith('image/')){ const r=new FileReader(); const img=document.createElement('img'); img.style.width='56px'; img.style.height='56px'; img.style.objectFit='cover'; img.style.borderRadius='8px'; preview.insertBefore(img,name); r.onload=()=>img.src=r.result; r.readAsDataURL(f); }
      else if(f.type.startsWith('audio/')){ const ic=document.createElement('div'); ic.textContent='ğŸ”Š'; ic.style.fontSize='22px'; preview.insertBefore(ic,name); }
      else { const ic=document.createElement('div'); ic.textContent='ğŸ“„'; ic.style.fontSize='22px'; preview.insertBefore(ic,name); }
      const rem = document.createElement('button'); rem.className='icon-btn'; rem.style.width='36px'; rem.style.height='36px'; rem.textContent='âœ•'; rem.addEventListener('click', ()=>{ pendingFile=null; fileInput.value=''; if(preview.parentNode) preview.parentNode.removeChild(preview); pendingPreviewEl=null; });
      preview.appendChild(rem);
      const composer = document.querySelector('.composer');
      if(composer) composer.insertBefore(preview, sendBtn);
      pendingPreviewEl = preview;
    });
  }

  // Send message
  function createMessageObject({text,file,userId}){
    const id = uid('m'); const time = timeNow();
    const msg = { id, text, userId, time, reactions: [], reactionCount: 0 };
    if(file) msg.file = { name: file.name, type: file.type, data: file.data };
    return msg;
  }

  function sendMessage(){
    if(!currentUser){ alert('áƒ’áƒ—áƒ®áƒáƒ•áƒ— áƒ¨áƒ”áƒ®áƒ•áƒ˜áƒ“áƒ”áƒ— áƒáƒœ áƒ“áƒáƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒ˜áƒ áƒ“áƒ”áƒ—'); return; }
    const text = composerInput ? composerInput.value.trim() : '';
    if(!text && !pendingFile) return;
    if(pendingFile && pendingFile instanceof File){
      const r = new FileReader();
      r.onload = ()=> {
        const fileObj = { name: pendingFile.name, type: pendingFile.type, data: r.result };
        const msg = createMessageObject({ text: text||'', file: fileObj, userId: currentUser.id });
        messages.push(msg); safeSave(LS_MESSAGES, messages); if(composerInput) composerInput.value=''; pendingFile=null; if(pendingPreviewEl && pendingPreviewEl.parentNode) pendingPreviewEl.parentNode.removeChild(pendingPreviewEl); pendingPreviewEl=null; renderMessages();
      };
      r.readAsDataURL(pendingFile);
    } else if(pendingFile && pendingFile.data){
      const msg = createMessageObject({ text: text||'', file: pendingFile, userId: currentUser.id });
      messages.push(msg); safeSave(LS_MESSAGES, messages); if(composerInput) composerInput.value=''; pendingFile=null; if(pendingPreviewEl && pendingPreviewEl.parentNode) pendingPreviewEl.parentNode.removeChild(pendingPreviewEl); pendingPreviewEl=null; renderMessages();
    } else {
      const msg = createMessageObject({ text: text||'', file:null, userId: currentUser.id });
      messages.push(msg); safeSave(LS_MESSAGES, messages); if(composerInput) composerInput.value=''; renderMessages();
    }
  }
  if(sendBtn) sendBtn.addEventListener('click', sendMessage);
  if(composerInput) composerInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } });

  // Recording
  if(recordBtn){
    recordBtn.addEventListener('click', async ()=>{
      if(isRecording){ if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop(); return; }
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio:true });
        mediaRecorder = new MediaRecorder(mediaStream);
        recordingChunks = [];
        mediaRecorder.ondataavailable = (ev)=>{ if(ev.data && ev.data.size) recordingChunks.push(ev.data); };
        mediaRecorder.onstop = ()=>{
          try {
            const blob = new Blob(recordingChunks, { type:'audio/webm' });
            const f = new File([blob], 'voice-'+Date.now()+'.webm', { type: blob.type });
            const reader = new FileReader();
            reader.onload = ()=>{
              pendingFile = { name: f.name, type: f.type, data: reader.result };
              if(pendingPreviewEl && pendingPreviewEl.parentNode) pendingPreviewEl.parentNode.removeChild(pendingPreviewEl);
              const preview = document.createElement('div'); preview.style.display='flex'; preview.style.alignItems='center'; preview.style.gap='8px'; preview.style.marginLeft='8px'; preview.style.padding='6px'; preview.style.borderRadius='8px'; preview.style.background='rgba(255,255,255,0.02)';
              const icon = document.createElement('div'); icon.textContent='ğŸ”Š'; icon.style.fontSize='22px';
              const name = document.createElement('div'); name.style.fontSize='13px'; name.style.color='var(--muted)'; name.textContent = f.name;
              const removeBtn = document.createElement('button'); removeBtn.className='icon-btn'; removeBtn.style.width='36px'; removeBtn.style.height='36px'; removeBtn.textContent='âœ•';
              removeBtn.addEventListener('click', ()=>{ pendingFile=null; fileInput.value=''; if(preview.parentNode) preview.parentNode.removeChild(preview); pendingPreviewEl=null; });
              preview.appendChild(icon); preview.appendChild(name); preview.appendChild(removeBtn);
              const composer = document.querySelector('.composer');
              if(composer) composer.insertBefore(preview, sendBtn);
              pendingPreviewEl = preview;
            };
            reader.readAsDataURL(blob);
            try { if(mediaStream && mediaStream.getTracks) mediaStream.getTracks().forEach(t=>t.stop()); } catch(e){}
          } catch(err){ console.error('record stop error', err); alert('áƒ©áƒáƒ¬áƒ”áƒ áƒ˜áƒ¡ áƒ“áƒáƒ›áƒ—áƒáƒ•áƒ áƒ”áƒ‘áƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ'); }
          isRecording=false; recordBtn.classList.remove('recording'); recordBtn.setAttribute('aria-pressed','false'); recordBtn.textContent = 'ğŸ¤';
        };
        mediaRecorder.start();
        isRecording=true; recordBtn.classList.add('recording'); recordBtn.setAttribute('aria-pressed','true'); recordBtn.textContent = 'â¹ï¸';
      } catch(err){ console.error('getUserMedia error', err); alert('áƒ›áƒ˜áƒ™áƒ áƒáƒ¤áƒáƒœáƒ˜áƒ¡ áƒ’áƒáƒ›áƒáƒ§áƒ”áƒœáƒ”áƒ‘áƒ áƒ¨áƒ”áƒ£áƒ«áƒšáƒ”áƒ‘áƒ”áƒšáƒ˜áƒ: ' + (err && err.message ? err.message : '')); isRecording=false; }
    });
  }

  // Theme toggle (fixed)
  function applyTheme(t){
    if(t === 'light') document.body.classList.add('light'); else document.body.classList.remove('light');
    safeSave(LS_THEME, t);
    updateThemeIcon(t);
  }
  function updateThemeIcon(t){
    if(!themeIcon) return;
    // simple icon swap: moon for dark, sun for light
    if(t === 'light'){
      themeIcon.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="5" stroke="#f59e0b" stroke-width="1.4"/><path d="M12 1v2M12 21v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4" stroke="#f59e0b" stroke-width="1.2" stroke-linecap="round"/></svg>';
    } else {
      themeIcon.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" fill="#06b6d4" opacity="0.12"/><path d="M21 12.79A9 9 0 1111.21 3" stroke="#06b6d4" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
    }
  }
  // initialize theme
  applyTheme(safeLoad(LS_THEME) || 'dark');
  if(themeToggle) themeToggle.addEventListener('click', ()=> applyTheme(document.body.classList.contains('light') ? 'dark' : 'light'));

  // Reactions: close panel on scroll/resize
  window.addEventListener('scroll', ()=> closeReactionPanel(), true);
  window.addEventListener('resize', ()=> closeReactionPanel());

  // Reaction panel close on Escape
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeReactionPanel(); });

  // View profile collapse behavior already wired above

  // Utilities: compute age
  function computeAge(year){
    if(!year) return '--';
    const y = parseInt(year,10);
    if(!y || isNaN(y)) return '--';
    const now = new Date();
    let age = now.getFullYear() - y;
    // rough: not checking month/day
    return age;
  }

  // Save/load helpers
  function saveAll(){ safeSave(LS_USERS, users); safeSave(LS_MESSAGES, messages); safeSave(LS_CURRENT, currentUser); }

  // Initial render
  try { initDemo(); } catch(e){ console.error(e); }
  try { updateAuthUI(); } catch(e){}
  try { renderUsers(); } catch(e){}
  try { renderMessages(); } catch(e){}

  // small helper: update header auth UI
  function updateAuthUI(){
    if(!statusText) return;
    if(currentUser){
      if(loginHeaderBtn) loginHeaderBtn.style.display='none';
      if(openRegisterBtn) openRegisterBtn.style.display='none';
      if(openRegisterBtn2) openRegisterBtn2.style.display='none';
      if(openProfileBtn) openProfileBtn.style.display='inline-flex';
      if(logoutBtn) logoutBtn.style.display='inline-flex';
      statusText.textContent = `áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ˜: @${currentUser.nick}`;
    } else {
      if(loginHeaderBtn) loginHeaderBtn.style.display='inline-flex';
      if(openRegisterBtn) openRegisterBtn.style.display='inline-flex';
      if(openRegisterBtn2) openRegisterBtn2.style.display='inline-flex';
      if(openProfileBtn) openProfileBtn.style.display='none';
      if(logoutBtn) logoutBtn.style.display='none';
      statusText.textContent = 'áƒ’áƒ—áƒ®áƒáƒ•áƒ— áƒ¨áƒ”áƒ®áƒ•áƒ˜áƒ“áƒ”áƒ— áƒáƒœ áƒ“áƒáƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒ˜áƒ áƒ“áƒ”áƒ—';
    }
  }

  // Expose for debug
  window._chat = { users, messages, currentUser, toggleReaction };

})(); // end IIFE
</script>
</body>
</html>
