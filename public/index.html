<!doctype html>
<html lang="ka">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ChatApp â€” áƒ¤áƒ£áƒœáƒ¥áƒªáƒ˜áƒáƒœáƒáƒšáƒ£áƒ áƒ˜</title>
<style>
:root{
  --bg-dark-1:#071024; --bg-dark-2:#071a2a;
  --panel-dark:rgba(255,255,255,0.02);
  --accent:#06b6d4; --muted:#94a3b8; --text-dark:#e6eef6;
  --radius:12px;
  --reaction-w:92px; --reaction-btn:56px; --reaction-font:28px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,var(--bg-dark-1),var(--bg-dark-2));color:var(--text-dark);-webkit-font-smoothing:antialiased}
body.light{background:linear-gradient(180deg,#ffffff,#f7fafc);color:#0b1220}
.app{display:grid;grid-template-columns:1fr 320px;height:100vh;padding:12px;gap:12px}
.left-col{display:flex;flex-direction:column;border-radius:10px;background:var(--panel-dark);overflow:hidden;min-width:0}
.header-left{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid rgba(255,255,255,0.03)}
body.light .header-left{border-bottom-color:rgba(2,6,23,0.06)}
.brand{font-weight:700;color:var(--accent)}
.online-indicator{font-size:13px;color:var(--muted)}
.messages{flex:1;padding:12px;overflow:auto;display:flex;flex-direction:column;gap:10px}
.message{max-width:80%;padding:10px;border-radius:12px;word-break:break-word}
.me{align-self:flex-end;background:linear-gradient(90deg,#0ea5a4,#0891b2);color:#042027}
.other{align-self:flex-start;background:rgba(255,255,255,0.03);color:var(--muted)}
body.light .other{background:rgba(2,6,23,0.04);color:#0b1220}
.msg-header{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.msg-header img{width:28px;height:28px;border-radius:50%;object-fit:cover}
.msg-author{font-weight:700;font-size:13px}
.meta{font-size:11px;opacity:0.9;margin-top:6px;text-align:right}
.composer{display:flex;gap:8px;padding:12px;border-top:1px solid rgba(255,255,255,0.02);align-items:center;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);position:sticky;bottom:0;left:0;right:0;backdrop-filter: blur(6px);z-index:1400}
.left-group{display:flex;gap:8px;align-items:center}
.input{flex:1;padding:12px;border-radius:10px;border:0;background:rgba(255,255,255,0.02);color:inherit;font-size:16px;height:48px}
body.light .input{background:rgba(2,6,23,0.04);color:#0b1220}
.icon-btn{width:44px;height:44px;border-radius:10px;border:0;background:rgba(255,255,255,0.03);display:inline-flex;align-items:center;justify-content:center;color:var(--muted);cursor:pointer}
body.light .icon-btn{background:rgba(2,6,23,0.03);color:#0b1220}
.send-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;background:var(--accent);border:0;border-radius:10px;color:#042027;cursor:pointer;font-weight:700}
.users-list{padding:12px;background:rgba(255,255,255,0.01);border-radius:8px;overflow:auto}
.user-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;cursor:pointer}
.user-item img{width:36px;height:36px;border-radius:50%;object-fit:cover;margin-right:8px}
.small{font-size:13px;color:var(--muted)}
.modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:3000}
.modal.hidden{display:none}
.modal .box{background:#071a2a;padding:16px;border-radius:8px;color:var(--text-dark);width:420px;max-width:94%}
body.light .modal .box{background:#fff;color:#0b1220}
.close{position:absolute;right:12px;top:8px;background:transparent;border:0;color:var(--muted);cursor:pointer}
.avatar-large{width:96px;height:96px;border-radius:50%;object-fit:cover}
.reaction-toggle{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:10px;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
.reaction-picker{position:fixed;display:flex;flex-direction:column;gap:8px;padding:8px;background:linear-gradient(180deg,#0f1724,#071024);border-radius:12px;box-shadow:0 12px 36px rgba(2,6,23,0.6);z-index:2000;max-height:60vh;overflow:auto;width:var(--reaction-w)}
.reaction-picker button{background:transparent;border:0;font-size:var(--reaction-font);width:var(--reaction-btn);height:var(--reaction-btn);cursor:pointer;border-radius:10px}
.reactions{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.react{background:rgba(255,255,255,0.02);border-radius:999px;padding:6px 10px;display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,0.03)}
.btn-delete{background:transparent;border:1px solid rgba(255,255,255,0.04);color:#ffb4b4;padding:6px 8px;border-radius:6px;cursor:pointer}
.record-btn{width:48px;height:48px;border-radius:12px;border:0;background:linear-gradient(180deg,#06b6d4,#0284a2);color:#042027;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
.record-btn.recording{background:linear-gradient(180deg,#ff3b3b,#c40000)}
@media(max-width:900px){.app{grid-template-columns:1fr}.users-list{display:none}}
</style>
</head>
<body>
<div class="app">
  <div class="left-col" role="main" aria-label="áƒ©áƒáƒ¢áƒ˜">
    <div class="header-left">
      <div>
        <div class="brand">ChatApp</div>
        <div id="statusText" class="online-indicator">áƒ’áƒ—áƒ®áƒáƒ•áƒ— áƒ¨áƒ”áƒ®áƒ•áƒ˜áƒ“áƒ”áƒ— áƒáƒœ áƒ“áƒáƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒ˜áƒ áƒ“áƒ”áƒ—</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="themeBtn" class="icon-btn" title="áƒ—áƒ”áƒ›áƒ" aria-label="áƒ—áƒ”áƒ›áƒ">ğŸŒ™</button>
        <button id="loginBtn" class="icon-btn" title="áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ" aria-label="áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ">ğŸ”</button>
        <button id="registerBtn" class="icon-btn" title="áƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒáƒªáƒ˜áƒ" aria-label="áƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒáƒªáƒ˜áƒ">âœï¸</button>
        <button id="profileBtn" class="icon-btn" title="áƒáƒ áƒáƒ¤áƒ˜áƒšáƒ˜" aria-label="áƒáƒ áƒáƒ¤áƒ˜áƒšáƒ˜" style="display:none">ğŸ‘¤</button>
        <button id="logoutBtn" class="icon-btn" title="áƒ’áƒáƒ¡áƒ•áƒšáƒ" aria-label="áƒ’áƒáƒ¡áƒ•áƒšáƒ" style="display:none">â‹</button>
      </div>
    </div>

    <div id="messages" class="messages" tabindex="0" aria-live="polite"></div>

    <div class="composer" role="region" aria-label="áƒ¨áƒ”áƒ¢áƒ§áƒáƒ‘áƒ˜áƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒ›áƒ¥áƒ›áƒœáƒ”áƒšáƒ˜">
      <div class="left-group">
        <label title="áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ">
          <input id="fileInput" type="file" accept="image/*,audio/*" style="display:none" />
          <button id="attachBtn" class="icon-btn" aria-label="áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ" title="áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ">
            <!-- SVG paperclip / attach -->
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M21.44 11.05l-8.49 8.49a5 5 0 01-7.07 0 5 5 0 010-7.07l8.49-8.49a3.5 3.5 0 014.95 4.95l-8.49 8.49a1.5 1.5 0 01-2.12 0 1.5 1.5 0 010-2.12l7.07-7.07" stroke="#94a3b8" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </label>

        <button id="emojiBtn" class="icon-btn" title="áƒ”áƒ›áƒáƒ¯áƒ˜" aria-label="áƒ”áƒ›áƒáƒ¯áƒ˜">ğŸ˜Š</button>

        <button id="recordBtn" class="record-btn" title="áƒ©áƒáƒ¬áƒ”áƒ áƒ" aria-pressed="false" aria-label="áƒ©áƒáƒ¬áƒ”áƒ áƒ">
          <svg id="micSvg" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="10" y="3" width="4" height="8" rx="2" fill="#042027" opacity="0.12"></rect>
            <path d="M12 14v4" stroke="#042027" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M8 11a4 4 0 0 0 8 0" stroke="#042027" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M19 11v1a7 7 0 0 1-14 0v-1" stroke="#042027" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" opacity="0.9"/>
          </svg>
        </button>
      </div>

      <input id="composerInput" class="input" type="text" placeholder="áƒ“áƒáƒ¬áƒ”áƒ áƒ”áƒ— áƒ¨áƒ”áƒ¢áƒ§áƒáƒ‘áƒ˜áƒœáƒ”áƒ‘áƒ..." aria-label="áƒ¨áƒ”áƒ¢áƒ§áƒáƒ‘áƒ˜áƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒ¢áƒ”áƒ¥áƒ¡áƒ¢áƒ˜" />
      <button id="sendBtn" class="send-btn" aria-label="áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ">áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ</button>
    </div>
  </div>

  <aside class="users-list" aria-label="áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒšáƒ”áƒ‘áƒ˜">
    <div style="display:flex;gap:8px;align-items:center;padding:12px">
      <input id="searchUsers" placeholder="áƒ«áƒ˜áƒ”áƒ‘áƒ" style="flex:1;padding:8px;border-radius:8px;border:0;background:rgba(255,255,255,0.01)" />
      <button id="openRegisterBtn" class="icon-btn" title="áƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒáƒªáƒ˜áƒ">âœï¸</button>
    </div>
    <div id="usersList" style="padding:12px"></div>
  </aside>
</div>

<!-- Modals -->
<div id="loginModal" class="modal hidden" role="dialog" aria-modal="true">
  <div class="box">
    <button class="close" id="closeLogin">âœ•</button>
    <h3>áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ</h3>
    <div class="small">áƒœáƒ˜áƒ™ áƒœáƒ”áƒ˜áƒ›áƒ˜</div>
    <input id="loginNick" style="width:100%;padding:8px;margin:6px 0" />
    <div class="small">áƒáƒáƒ áƒáƒšáƒ˜</div>
    <input id="loginPass" type="password" style="width:100%;padding:8px;margin:6px 0" />
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button id="loginSubmit" class="send-btn">áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ</button>
      <button id="loginCancel" class="icon-btn">âœ•</button>
    </div>
  </div>
</div>

<div id="registerModal" class="modal hidden" role="dialog" aria-modal="true">
  <div class="box">
    <button class="close" id="closeRegister">âœ•</button>
    <h3>áƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒáƒªáƒ˜áƒ</h3>
    <div style="display:flex;flex-direction:column;gap:8px">
      <input id="regFirst" placeholder="áƒ¡áƒáƒ®áƒ”áƒšáƒ˜" style="padding:8px" />
      <input id="regLast" placeholder="áƒ’áƒ•áƒáƒ áƒ˜" style="padding:8px" />
      <div style="display:flex;gap:8px">
        <input id="regYear" placeholder="áƒ“áƒáƒ‘. áƒ¬áƒ”áƒšáƒ˜" type="number" style="flex:1;padding:8px" />
        <input id="regNick" placeholder="áƒœáƒ˜áƒ™ áƒœáƒ”áƒ˜áƒ›áƒ˜" style="flex:1;padding:8px" />
      </div>
      <div style="display:flex;gap:8px">
        <input id="regPass" placeholder="áƒáƒáƒ áƒáƒšáƒ˜" type="password" style="flex:1;padding:8px" />
        <input id="regPassConfirm" placeholder="áƒ’áƒáƒ˜áƒ›áƒ”áƒáƒ áƒ”áƒ—" type="password" style="flex:1;padding:8px" />
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="regAvatarInput" type="file" accept="image/*" style="display:none" />
        <button id="regAvatarBtn" class="icon-btn">ğŸ“·</button>
        <div id="regAvatarPreview" class="small">áƒáƒ•áƒáƒ¢áƒáƒ áƒ˜ (áƒáƒ áƒáƒ¡áƒáƒ•áƒáƒšáƒ“áƒ”áƒ‘áƒ£áƒšáƒ)</div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="regSubmit" class="send-btn">áƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒáƒªáƒ˜áƒ</button>
        <button id="regCancel" class="icon-btn">âœ•</button>
      </div>
    </div>
  </div>
</div>

<div id="profileModal" class="modal hidden" role="dialog" aria-modal="true">
  <div class="box">
    <button class="close" id="closeProfile">âœ•</button>
    <h3>áƒáƒ áƒáƒ¤áƒ˜áƒšáƒ˜</h3>
    <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
      <img id="profileAvatar" class="avatar-large" src="https://picsum.photos/96" alt="áƒáƒ•áƒáƒ¢áƒáƒ áƒ˜" />
      <div>
        <div id="profileFullName" style="font-weight:700">áƒ¡áƒáƒ®áƒ”áƒšáƒ˜ áƒ’áƒ•áƒáƒ áƒ˜</div>
        <div id="profileNickname" class="small">@áƒœáƒ˜áƒ™áƒœáƒ”áƒ˜áƒ›áƒ˜</div>
      </div>
    </div>
    <div style="margin-top:12px" class="small">áƒ“áƒáƒ‘. áƒ¬áƒ”áƒšáƒ˜: <span id="profileYear">----</span></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <input id="avatarUploadInput" type="file" accept="image/*" style="display:none" />
      <button id="changeAvatarBtn" class="send-btn">áƒáƒ•áƒáƒ¢áƒáƒ áƒ˜áƒ¡ áƒ¨áƒ”áƒªáƒ•áƒšáƒ</button>
      <button id="closeProfileBtn" class="icon-btn">âœ•</button>
    </div>
  </div>
</div>

<div id="viewProfileModal" class="modal hidden" role="dialog" aria-modal="true">
  <div class="box">
    <button class="close" id="closeViewProfile">âœ•</button>
    <h3>áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒšáƒ˜áƒ¡ áƒáƒ áƒáƒ¤áƒ˜áƒšáƒ˜</h3>
    <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
      <img id="viewAvatar" class="avatar-large" src="https://picsum.photos/96" alt="áƒáƒ•áƒáƒ¢áƒáƒ áƒ˜" />
      <div>
        <div id="viewFullName" style="font-weight:700">áƒ¡áƒáƒ®áƒ”áƒšáƒ˜ áƒ’áƒ•áƒáƒ áƒ˜</div>
        <div id="viewNickname" class="small">@áƒœáƒ˜áƒ™áƒœáƒ”áƒ˜áƒ›áƒ˜</div>
      </div>
    </div>
    <div style="margin-top:12px" class="small">áƒ“áƒáƒ‘. áƒ¬áƒ”áƒšáƒ˜: <span id="viewYear">----</span></div>
  </div>
</div>

<!-- Reaction picker -->
<div id="reactionPicker" class="reaction-picker" style="display:none">
  <button data-emoji="ğŸ˜€">ğŸ˜€</button>
  <button data-emoji="ğŸ˜">ğŸ˜</button>
  <button data-emoji="ğŸ˜‚">ğŸ˜‚</button>
  <button data-emoji="ğŸ¤£">ğŸ¤£</button>
  <button data-emoji="ğŸ˜…">ğŸ˜…</button>
  <button data-emoji="ğŸ˜Š">ğŸ˜Š</button>
  <button data-emoji="ğŸ˜">ğŸ˜</button>
  <button data-emoji="ğŸ˜‡">ğŸ˜‡</button>
  <button data-emoji="ğŸ˜†">ğŸ˜†</button>
  <button data-emoji="ğŸ™ƒ">ğŸ™ƒ</button>
  <button data-emoji="ğŸ¤”">ğŸ¤”</button>
  <button data-emoji="ğŸ¤—">ğŸ¤—</button>
  <button data-emoji="ğŸ™„">ğŸ™„</button>
  <button data-emoji="ğŸ‘">ğŸ‘</button>
  <button data-emoji="â¤ï¸">â¤ï¸</button>
</div>

<script>
/* áƒ¡áƒ áƒ£áƒšáƒ˜ JS: áƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒáƒªáƒ˜áƒ/áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ, áƒ›áƒ”áƒ¡áƒ˜áƒ¯áƒ”áƒ‘áƒ˜, áƒ¤áƒáƒ˜áƒšáƒ˜, áƒ©áƒáƒ¬áƒ”áƒ áƒ, áƒ áƒ”áƒáƒ¥áƒªáƒ˜áƒ”áƒ‘áƒ˜, áƒáƒ áƒáƒ¤áƒ˜áƒšáƒ˜ */
(async function(){
  // Elements
  const messagesEl = document.getElementById('messages');
  const usersListEl = document.getElementById('usersList');
  const composerInput = document.getElementById('composerInput');
  const sendBtn = document.getElementById('sendBtn');
  const attachBtn = document.getElementById('attachBtn');
  const fileInput = document.getElementById('fileInput');
  const recordBtn = document.getElementById('recordBtn');
  const reactionPicker = document.getElementById('reactionPicker');
  const emojiBtn = document.getElementById('emojiBtn');

  const loginBtn = document.getElementById('loginBtn');
  const registerBtn = document.getElementById('registerBtn');
  const profileBtn = document.getElementById('profileBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const statusText = document.getElementById('statusText');
  const themeBtn = document.getElementById('themeBtn');
  const openRegisterBtn = document.getElementById('openRegisterBtn');

  // Modals & inputs
  const loginModal = document.getElementById('loginModal');
  const loginSubmit = document.getElementById('loginSubmit');
  const loginCancel = document.getElementById('loginCancel');
  const loginNick = document.getElementById('loginNick');
  const loginPass = document.getElementById('loginPass');
  const closeLogin = document.getElementById('closeLogin');

  const registerModal = document.getElementById('registerModal');
  const regSubmit = document.getElementById('regSubmit');
  const regCancel = document.getElementById('regCancel');
  const regFirst = document.getElementById('regFirst');
  const regLast = document.getElementById('regLast');
  const regYear = document.getElementById('regYear');
  const regNick = document.getElementById('regNick');
  const regPass = document.getElementById('regPass');
  const regPassConfirm = document.getElementById('regPassConfirm');
  const regAvatarBtn = document.getElementById('regAvatarBtn');
  const regAvatarInput = document.getElementById('regAvatarInput');
  const regAvatarPreview = document.getElementById('regAvatarPreview');
  const closeRegister = document.getElementById('closeRegister');

  const profileModal = document.getElementById('profileModal');
  const closeProfile = document.getElementById('closeProfile');
  const closeProfileBtn = document.getElementById('closeProfileBtn');
  const profileAvatar = document.getElementById('profileAvatar');
  const profileFullName = document.getElementById('profileFullName');
  const profileNickname = document.getElementById('profileNickname');
  const profileYear = document.getElementById('profileYear');
  const changeAvatarBtn = document.getElementById('changeAvatarBtn');
  const avatarUploadInput = document.getElementById('avatarUploadInput');
  const editProfileBtn = document.getElementById('editProfileBtn');

  const viewProfileModal = document.getElementById('viewProfileModal');
  const closeViewProfile = document.getElementById('closeViewProfile');
  const viewAvatar = document.getElementById('viewAvatar');
  const viewFullName = document.getElementById('viewFullName');
  const viewNickname = document.getElementById('viewNickname');
  const viewYear = document.getElementById('viewYear');

  // Storage keys
  const LS_USERS = 'chatapp_users_v2';
  const LS_CURRENT = 'chatapp_current_v2';
  const LS_MESSAGES = 'chatapp_messages_v2';
  const LS_THEME = 'chatapp_theme_v2';

  // State
  let users = load(LS_USERS) || [];
  let currentUser = load(LS_CURRENT) || null;
  let messages = load(LS_MESSAGES) || [];

  let pendingFile = null;
  let pendingPreviewEl = null;

  // Recorder
  let mediaRecorder = null;
  let mediaStream = null;
  let chunks = [];
  let isRecording = false;

  // Helpers
  function save(key, val){ try { localStorage.setItem(key, JSON.stringify(val)); } catch(e){} }
  function load(key){ try { return JSON.parse(localStorage.getItem(key)); } catch(e){ return null; } }
  function uid(prefix='id'){ return prefix + '_' + Date.now().toString(36) + Math.random().toString(36).slice(2,6); }
  function timeNow(){ const d=new Date(); return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  async function sha256Hex(str){
    const enc = new TextEncoder();
    const data = enc.encode(str);
    const hash = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  // Init demo
  function initDemo(){
    if(!users || users.length === 0){
      users = [
        { id: 'u_demo1', first:'áƒáƒœáƒ', last:'áƒ›áƒªáƒ˜áƒ áƒ˜áƒ¨áƒ•áƒ˜áƒšáƒ˜', year:'1992', nick:'ana92', avatar:'https://picsum.photos/seed/ana/96', passHash:null },
        { id: 'u_demo2', first:'áƒ’áƒ˜áƒáƒ áƒ’áƒ˜', last:'áƒ™áƒáƒáƒáƒœáƒáƒ«áƒ”', year:'1988', nick:'giorgi88', avatar:'https://picsum.photos/seed/giorgi/96', passHash:null }
      ];
      save(LS_USERS, users);
    }
    if(!messages || messages.length === 0){
      messages = [
        { id: uid('m'), text:'áƒ’áƒáƒ›áƒáƒ áƒ¯áƒáƒ‘áƒ! áƒ”áƒ¡ áƒáƒ áƒ˜áƒ¡ áƒ“áƒ”áƒ›áƒ áƒ›áƒ”áƒ¡áƒ˜áƒ¯áƒ˜.', userId: users[0].id, time: timeNow(), reactions:[], reactionCount:0 },
        { id: uid('m'), text:'áƒ™áƒáƒ áƒ’áƒáƒ“, áƒ›áƒáƒ“áƒšáƒáƒ‘áƒ!', userId: users[1].id, time: timeNow(), reactions:[], reactionCount:0 }
      ];
      save(LS_MESSAGES, messages);
    }
  }

  // Theme
  function applyTheme(t){ if(t==='light') document.body.classList.add('light'); else document.body.classList.remove('light'); save(LS_THEME, t); }
  applyTheme(load(LS_THEME) || 'dark');
  themeBtn.addEventListener('click', ()=> applyTheme(document.body.classList.contains('light') ? 'dark' : 'light'));

  // UI updates
  function updateAuthUI(){
    if(currentUser){
      loginBtn.style.display='none'; registerBtn.style.display='none'; profileBtn.style.display='inline-flex'; logoutBtn.style.display='inline-flex';
      statusText.textContent = `áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ˜: @${currentUser.nick}`;
    } else {
      loginBtn.style.display='inline-flex'; registerBtn.style.display='inline-flex'; profileBtn.style.display='none'; logoutBtn.style.display='none';
      statusText.textContent = 'áƒ’áƒ—áƒ®áƒáƒ•áƒ— áƒ¨áƒ”áƒ®áƒ•áƒ˜áƒ“áƒ”áƒ— áƒáƒœ áƒ“áƒáƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒ˜áƒ áƒ“áƒ”áƒ—';
    }
  }

  // Render users
  function renderUsers(){
    usersListEl.innerHTML = '';
    users.forEach(u=>{
      const el = document.createElement('div');
      el.className = 'user-item';
      el.innerHTML = `<div style="display:flex;align-items:center"><img src="${u.avatar||'https://picsum.photos/36'}" alt="" /><div style="margin-left:8px"><strong>${escapeHtml(u.first)} ${escapeHtml(u.last)}</strong><div class="small">@${escapeHtml(u.nick)}</div></div></div><div>${currentUser && currentUser.id===u.id ? '<span class="small">áƒ›áƒ”</span>' : '<button class="icon-btn view-btn" data-id="'+u.id+'">ğŸ‘ï¸</button>'}</div>`;
      usersListEl.appendChild(el);
    });
  }

  // Render messages
  function renderMessages(){
    messagesEl.innerHTML = '';
    messages.forEach(m=>{
      const author = users.find(u=>u.id===m.userId) || {nick:'unknown', first:'', last:'', avatar:'https://picsum.photos/36'};
      const el = document.createElement('div');
      el.className = 'message ' + (currentUser && currentUser.id===m.userId ? 'me' : 'other');
      el.dataset.id = m.id;
      el.innerHTML = `<div class="msg-header"><img src="${author.avatar||'https://picsum.photos/36'}" alt="" /><div><div class="msg-author">${escapeHtml(author.nick)}</div><div class="small">${escapeHtml(author.first)} ${escapeHtml(author.last)}</div></div></div><div>${escapeHtml(m.text||'')}</div>`;
      if(m.file){
        if(m.file.type && m.file.type.startsWith('image/')){
          const img = document.createElement('img'); img.src = m.file.data; img.className='uploaded'; img.style.maxWidth='220px'; img.style.marginTop='8px'; el.appendChild(img);
        } else if(m.file.type && m.file.type.startsWith('audio/')){
          const audio = document.createElement('audio'); audio.controls=true; audio.src = m.file.data; audio.style.marginTop='8px'; el.appendChild(audio);
        } else {
          const link = document.createElement('div'); link.textContent = m.file.name || 'áƒ¤áƒáƒ˜áƒšáƒ˜'; link.style.marginTop='8px'; link.className='small'; el.appendChild(link);
        }
      }
      const actions = document.createElement('div'); actions.className='msg-actions';
      const toggle = document.createElement('button'); toggle.className='reaction-toggle'; toggle.textContent='ğŸ™‚';
      const badge = document.createElement('span'); badge.className='small'; badge.style.marginLeft='6px'; badge.textContent = m.reactionCount || 0;
      toggle.appendChild(badge);
      actions.appendChild(toggle);
      const reactionsWrap = document.createElement('div'); reactionsWrap.className='reactions';
      (m.reactions||[]).forEach(r=>{
        const rb = document.createElement('div'); rb.className='react'; rb.innerHTML = `${escapeHtml(r.emoji)} <span class="small">${r.count}</span>`; reactionsWrap.appendChild(rb);
      });
      actions.appendChild(reactionsWrap);
      if(currentUser && currentUser.id===m.userId){
        const del = document.createElement('button'); del.className='btn-delete'; del.textContent='áƒ¬áƒáƒ¨áƒšáƒ';
        del.addEventListener('click', ()=>{ if(confirm('áƒœáƒáƒ›áƒ“áƒ•áƒ˜áƒšáƒáƒ“ áƒ¬áƒáƒ¨áƒšáƒ?')){ messages = messages.filter(x=>x.id!==m.id); save(LS_MESSAGES, messages); renderMessages(); }});
        actions.appendChild(del);
      }
      el.appendChild(actions);
      messagesEl.appendChild(el);
    });
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // Open/close modal helpers
  function openModal(el){ el.classList.remove('hidden'); const c = el.querySelector('.box'); if(c) c.focus(); }
  function closeModal(el){ el.classList.add('hidden'); }

  // Register handlers
  regAvatarBtn.addEventListener('click', ()=> regAvatarInput.click());
  regAvatarInput.addEventListener('change', (e)=> {
    const f = e.target.files && e.target.files[0]; if(!f) return;
    const r = new FileReader(); r.onload = ()=> { regAvatarPreview.textContent = f.name; regAvatarPreview.style.backgroundImage = `url(${r.result})`; regAvatarPreview.style.backgroundSize='cover'; regAvatarPreview.style.padding='8px'; regAvatarPreview.style.borderRadius='8px'; };
    r.readAsDataURL(f);
  });

  regSubmit.addEventListener('click', async ()=>{
    const first = regFirst.value.trim(), last = regLast.value.trim(), year = regYear.value.trim(), nick = regNick.value.trim();
    const pass = regPass.value, passC = regPassConfirm.value;
    if(!first||!last||!year||!nick||!pass||!passC){ alert('áƒ’áƒ—áƒ®áƒáƒ•áƒ— áƒ¨áƒ”áƒáƒ•áƒ¡áƒáƒ— áƒ§áƒ•áƒ”áƒšáƒ áƒ•áƒ”áƒšáƒ˜'); return; }
    if(pass !== passC){ alert('áƒáƒáƒ áƒáƒšáƒ”áƒ‘áƒ˜ áƒáƒ  áƒ”áƒ›áƒ—áƒ®áƒ•áƒ”áƒ•áƒ'); return; }
    if(pass.length < 6){ alert('áƒáƒáƒ áƒáƒšáƒ˜ áƒ£áƒœáƒ“áƒ áƒ˜áƒ§áƒáƒ¡ áƒ›áƒ˜áƒœáƒ˜áƒ›áƒ£áƒ› 6 áƒ¡áƒ˜áƒ›áƒ‘áƒáƒšáƒ'); return; }
    if(users.some(u=>u.nick.toLowerCase()===nick.toLowerCase())){ alert('áƒœáƒ˜áƒ™áƒ˜ áƒ“áƒáƒ™áƒáƒ•áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ'); return; }
    const passHash = await sha256Hex(pass);
    const newUser = { id: uid('u'), first, last, year, nick, avatar:null, passHash };
    const f = regAvatarInput.files && regAvatarInput.files[0];
    if(f){
      const r = new FileReader(); r.onload = ()=> { newUser.avatar = r.result; users.push(newUser); save(LS_USERS, users); currentUser = newUser; save(LS_CURRENT, currentUser); closeModal(registerModal); updateAuthUI(); renderUsers(); renderMessages(); };
      r.readAsDataURL(f);
    } else {
      users.push(newUser); save(LS_USERS, users); currentUser = newUser; save(LS_CURRENT, currentUser); closeModal(registerModal); updateAuthUI(); renderUsers(); renderMessages();
    }
  });
  regCancel.addEventListener('click', ()=> closeModal(registerModal));
  closeRegister.addEventListener('click', ()=> closeModal(registerModal));

  // Login handlers
  loginSubmit.addEventListener('click', async ()=>{
    const nick = loginNick.value.trim(), pass = loginPass.value;
    if(!nick||!pass){ alert('áƒ¨áƒ”áƒ˜áƒ§áƒ•áƒáƒœáƒ”áƒ— áƒœáƒ˜áƒ™áƒ˜ áƒ“áƒ áƒáƒáƒ áƒáƒšáƒ˜'); return; }
    const user = users.find(u=>u.nick.toLowerCase()===nick.toLowerCase());
    if(!user){ alert('áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ˜ áƒ•áƒ”áƒ  áƒ›áƒáƒ˜áƒ«áƒ”áƒ‘áƒœáƒ'); return; }
    if(!user.passHash){ alert('áƒáƒ› áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ¡ áƒáƒáƒ áƒáƒšáƒ˜ áƒáƒ  áƒáƒ¥áƒ•áƒ¡'); return; }
    const h = await sha256Hex(pass);
    if(h !== user.passHash){ alert('áƒáƒáƒ áƒáƒšáƒ˜ áƒáƒ áƒáƒ¡áƒ¬áƒáƒ áƒ˜áƒ'); return; }
    currentUser = user; save(LS_CURRENT, currentUser); closeModal(loginModal); updateAuthUI(); renderUsers(); renderMessages();
  });
  loginCancel.addEventListener('click', ()=> closeModal(loginModal));
  closeLogin.addEventListener('click', ()=> closeModal(loginModal));

  // Header buttons
  loginBtn.addEventListener('click', ()=> openModal(loginModal));
  registerBtn.addEventListener('click', ()=> openModal(registerModal));
  openRegisterBtn.addEventListener('click', ()=> openModal(registerModal));
  logoutBtn.addEventListener('click', ()=> { if(confirm('áƒœáƒáƒ›áƒ“áƒ•áƒ˜áƒšáƒáƒ“ áƒ’áƒáƒ¡áƒ•áƒšáƒ?')){ currentUser=null; save(LS_CURRENT, null); updateAuthUI(); renderUsers(); renderMessages(); }});
  profileBtn.addEventListener('click', ()=> { if(!currentUser){ alert('áƒ’áƒ—áƒ®áƒáƒ•áƒ— áƒ¨áƒ”áƒ®áƒ•áƒ˜áƒ“áƒ”áƒ—'); return; } showProfile(); openModal(profileModal); });

  closeProfile.addEventListener('click', ()=> closeModal(profileModal));
  closeProfileBtn.addEventListener('click', ()=> closeModal(profileModal));
  changeAvatarBtn.addEventListener('click', ()=> avatarUploadInput.click());
  avatarUploadInput.addEventListener('change', (e)=> {
    const f = e.target.files && e.target.files[0]; if(!f || !currentUser) return;
    const r = new FileReader(); r.onload = ()=> { currentUser.avatar = r.result; const idx = users.findIndex(u=>u.id===currentUser.id); if(idx>=0) users[idx].avatar = currentUser.avatar; save(LS_USERS, users); save(LS_CURRENT, currentUser); showProfile(); renderUsers(); renderMessages(); };
    r.readAsDataURL(f);
  });

  function showProfile(){ if(!currentUser) return; profileAvatar.src = currentUser.avatar || 'https://picsum.photos/96'; profileFullName.textContent = `${currentUser.first} ${currentUser.last}`; profileNickname.textContent = `@${currentUser.nick}`; profileYear.textContent = currentUser.year || '----'; }

  // View other profile
  usersListEl.addEventListener('click', (e)=>{
    const btn = e.target.closest('.view-btn');
    if(!btn) return;
    const id = btn.dataset.id;
    const u = users.find(x=>x.id===id);
    if(!u) return;
    viewAvatar.src = u.avatar || 'https://picsum.photos/96';
    viewFullName.textContent = `${u.first} ${u.last}`;
    viewNickname.textContent = `@${u.nick}`;
    viewYear.textContent = u.year || '----';
    openModal(viewProfileModal);
  });
  closeViewProfile.addEventListener('click', ()=> closeModal(viewProfileModal));

  // Attach file preview
  attachBtn.addEventListener('click', ()=> fileInput.click());
  fileInput.addEventListener('change', (e)=>{
    const f = e.target.files && e.target.files[0]; if(!f) return;
    pendingFile = f;
    if(pendingPreviewEl && pendingPreviewEl.parentNode) pendingPreviewEl.parentNode.removeChild(pendingPreviewEl);
    const preview = document.createElement('div'); preview.style.display='flex'; preview.style.alignItems='center'; preview.style.gap='8px'; preview.style.marginLeft='8px'; preview.style.padding='6px'; preview.style.borderRadius='8px'; preview.style.background='rgba(255,255,255,0.02)';
    const name = document.createElement('div'); name.className='small'; name.textContent = f.name; preview.appendChild(name);
    if(f.type.startsWith('image/')){ const r=new FileReader(); const img=document.createElement('img'); img.style.width='56px'; img.style.height='56px'; img.style.objectFit='cover'; img.style.borderRadius='8px'; preview.insertBefore(img,name); r.onload=()=>img.src=r.result; r.readAsDataURL(f); }
    else if(f.type.startsWith('audio/')){ const ic=document.createElement('div'); ic.textContent='ğŸ”Š'; ic.style.fontSize='22px'; preview.insertBefore(ic,name); }
    else { const ic=document.createElement('div'); ic.textContent='ğŸ“„'; ic.style.fontSize='22px'; preview.insertBefore(ic,name); }
    const rem = document.createElement('button'); rem.className='icon-btn'; rem.style.width='36px'; rem.style.height='36px'; rem.textContent='âœ•'; rem.addEventListener('click', ()=>{ pendingFile=null; fileInput.value=''; if(preview.parentNode) preview.parentNode.removeChild(preview); pendingPreviewEl=null; });
    preview.appendChild(rem);
    document.querySelector('.composer').insertBefore(preview, sendBtn);
    pendingPreviewEl = preview;
  });

  // Send message
  function createMessage({text,file,userId}){
    const id = uid('m'); const time = timeNow();
    const msg = { id, text, userId, time, reactions:[], reactionCount:0 };
    if(file) msg.file = { name: file.name, type: file.type, data: file.data };
    return msg;
  }

  async function sendMessage(){
    if(!currentUser){ alert('áƒ’áƒ—áƒ®áƒáƒ•áƒ— áƒ¨áƒ”áƒ®áƒ•áƒ˜áƒ“áƒ”áƒ— áƒáƒœ áƒ“áƒáƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒ˜áƒ áƒ“áƒ”áƒ—'); return; }
    const text = composerInput.value.trim();
    if(!text && !pendingFile) return;
    if(pendingFile && pendingFile instanceof File){
      const r = new FileReader(); r.onload = ()=> {
        const fileObj = { name: pendingFile.name, type: pendingFile.type, data: r.result };
        const msg = createMessage({ text: text||'', file: fileObj, userId: currentUser.id });
        messages.push(msg); save(LS_MESSAGES, messages); composerInput.value=''; pendingFile=null; if(pendingPreviewEl) pendingPreviewEl.remove(); pendingPreviewEl=null; renderMessages();
      }; r.readAsDataURL(pendingFile);
    } else if(pendingFile && pendingFile.data){
      const msg = createMessage({ text: text||'', file: pendingFile, userId: currentUser.id });
      messages.push(msg); save(LS_MESSAGES, messages); composerInput.value=''; pendingFile=null; if(pendingPreviewEl) pendingPreviewEl.remove(); pendingPreviewEl=null; renderMessages();
    } else {
      const msg = createMessage({ text: text||'', file:null, userId: currentUser.id });
      messages.push(msg); save(LS_MESSAGES, messages); composerInput.value=''; renderMessages();
    }
  }
  sendBtn.addEventListener('click', sendMessage);
  composerInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } });

  // Recording
  recordBtn.addEventListener('click', async ()=>{
    if(isRecording){ if(mediaRecorder && mediaRecorder.state!=='inactive') mediaRecorder.stop(); return; }
    try {
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio:true });
      mediaRecorder = new MediaRecorder(mediaStream);
      chunks = [];
      mediaRecorder.ondataavailable = (ev)=>{ if(ev.data && ev.data.size) chunks.push(ev.data); };
      mediaRecorder.onstop = ()=>{
        try {
          const blob = new Blob(chunks, { type:'audio/webm' });
          const f = new File([blob], 'voice-'+Date.now()+'.webm', { type: blob.type });
          const r = new FileReader();
          r.onload = ()=>{
            pendingFile = { name: f.name, type: f.type, data: r.result };
            if(pendingPreviewEl && pendingPreviewEl.parentNode) pendingPreviewEl.parentNode.removeChild(pendingPreviewEl);
            const preview = document.createElement('div'); preview.style.display='flex'; preview.style.alignItems='center'; preview.style.gap='8px'; preview.style.marginLeft='8px'; preview.style.padding='6px'; preview.style.borderRadius='8px'; preview.style.background='rgba(255,255,255,0.02)';
            const icon = document.createElement('div'); icon.textContent='ğŸ”Š'; icon.style.fontSize='22px'; preview.appendChild(icon);
            const name = document.createElement('div'); name.className='small'; name.textContent = f.name; preview.appendChild(name);
            const rem = document.createElement('button'); rem.className='icon-btn'; rem.style.width='36px'; rem.style.height='36px'; rem.textContent='âœ•'; rem.addEventListener('click', ()=>{ pendingFile=null; fileInput.value=''; if(preview.parentNode) preview.parentNode.removeChild(preview); pendingPreviewEl=null; });
            preview.appendChild(rem);
            document.querySelector('.composer').insertBefore(preview, sendBtn);
            pendingPreviewEl = preview;
          };
          r.readAsDataURL(blob);
          try { if(mediaStream && mediaStream.getTracks) mediaStream.getTracks().forEach(t=>t.stop()); } catch(e){}
        } catch(err){ console.error('record stop error', err); alert('áƒ©áƒáƒ¬áƒ”áƒ áƒ˜áƒ¡ áƒ“áƒáƒ›áƒ—áƒáƒ•áƒ áƒ”áƒ‘áƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ'); }
        isRecording=false; recordBtn.classList.remove('recording'); recordBtn.setAttribute('aria-pressed','false'); recordBtn.innerHTML = '<svg id="micSvg" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="10" y="3" width="4" height="8" rx="2" fill="#042027" opacity="0.12"></rect><path d="M12 14v4" stroke="#042027" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 11a4 4 0 0 0 8 0" stroke="#042027" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>';
      };
      mediaRecorder.start();
      isRecording=true; recordBtn.classList.add('recording'); recordBtn.setAttribute('aria-pressed','true'); recordBtn.innerHTML='â¹ï¸';
    } catch(err){ console.error('getUserMedia', err); alert('áƒ›áƒ˜áƒ™áƒ áƒáƒ¤áƒáƒœáƒ˜áƒ¡ áƒ’áƒáƒ›áƒáƒ§áƒ”áƒœáƒ”áƒ‘áƒ áƒ¨áƒ”áƒ£áƒ«áƒšáƒ”áƒ‘áƒ”áƒšáƒ˜áƒ'); isRecording=false; }
  });

  // Reactions: open picker near toggle, apply reaction
  let activeToggle = null;
  document.addEventListener('click', (e)=>{
    const toggle = e.target.closest('.reaction-toggle');
    if(toggle){
      e.stopPropagation();
      const msgEl = toggle.closest('.message');
      if(!msgEl) return;
      if(activeToggle === toggle){ closeReactionPicker(); return; }
      activeToggle = toggle;
      positionPicker(toggle, reactionPicker);
      reactionPicker.style.display='flex';
      return;
    }
    const pick = e.target.closest('#reactionPicker button, .reaction-picker button');
    if(pick && activeToggle){
      const emoji = pick.dataset.emoji || pick.textContent;
      const msgEl = activeToggle.closest('.message');
      if(!msgEl) return;
      const mid = msgEl.dataset.id;
      const msg = messages.find(m=>m.id===mid);
      if(!msg) return;
      const found = (msg.reactions||[]).find(r=>r.emoji===emoji);
      if(found) found.count += 1; else { msg.reactions = msg.reactions || []; msg.reactions.push({ emoji, count:1 }); }
      msg.reactionCount = (msg.reactionCount||0) + 1;
      save(LS_MESSAGES, messages);
      renderMessages();
      closeReactionPicker();
      return;
    }
    if(!e.target.closest('.reaction-picker') && !e.target.closest('.reaction-toggle')) closeReactionPicker();
  });

  function closeReactionPicker(){ reactionPicker.style.display='none'; activeToggle = null; }
  function positionPicker(toggle, picker){
    const rect = toggle.getBoundingClientRect();
    picker.style.left = Math.max(8, rect.left + rect.width/2 - picker.offsetWidth/2) + 'px';
    picker.style.top = Math.max(8, rect.top - picker.offsetHeight - 12) + 'px';
  }

  // Emoji quick insert
  emojiBtn.addEventListener('click', ()=>{
    const emoji = 'ğŸ˜Š';
    const el = composerInput; const s = el.selectionStart || el.value.length; const e = el.selectionEnd || s;
    el.value = el.value.slice(0,s) + emoji + el.value.slice(e);
    el.focus(); el.setSelectionRange(s+emoji.length, s+emoji.length);
  });

  // Close modals on Escape
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeModal(loginModal); closeModal(registerModal); closeModal(profileModal); closeModal(viewProfileModal); closeReactionPicker(); } });

  // Utilities: save/load messages & users
  function saveMessages(){ save(LS_MESSAGES, messages); }
  function saveUsers(){ save(LS_USERS, users); }
  function saveCurrent(){ save(LS_CURRENT, currentUser); }

  // Initial setup
  initDemo();
  updateAuthUI();
  renderUsers();
  renderMessages();

  // Expose for debugging (optional)
  window._chat = { users, messages, currentUser };

})(); // end IIFE
</script>
</body>
</html>
