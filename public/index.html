<!doctype html>
<html lang="ka">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ChatApp — Firestore Realtime</title>
<style>
:root{--bg:#071024;--panel:rgba(255,255,255,0.02);--accent:#06b6d4;--muted:#94a3b8;--text:#e6eef6}
*{box-sizing:border-box}html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,Helvetica;background:linear-gradient(180deg,var(--bg),#071a2a);color:var(--text);-webkit-font-smoothing:antialiased}
.container{max-width:980px;margin:18px auto;padding:12px;display:grid;grid-template-columns:1fr 320px;gap:12px}
.panel{background:var(--panel);padding:12px;border-radius:10px;overflow:hidden}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.brand{font-weight:700;color:var(--accent)}
.messages{height:64vh;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
.msg{max-width:78%;padding:10px;border-radius:12px;box-shadow:0 8px 20px rgba(2,6,23,0.4)}
.me{align-self:flex-end;background:linear-gradient(90deg,#0ea5a4,#0891b2);color:#042027}
.other{align-self:flex-start;background:rgba(255,255,255,0.03);color:var(--muted)}
.meta{font-size:12px;color:var(--muted);margin-top:6px;text-align:right}
.composer{display:flex;gap:8px;padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
.input{flex:1;padding:12px;border-radius:10px;border:0;background:rgba(255,255,255,0.02);color:inherit}
.send{background:var(--accent);border:0;padding:10px 14px;border-radius:10px;color:#042027;font-weight:700;cursor:pointer}
.users{padding:8px;display:flex;flex-direction:column;gap:8px}
.user{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;background:rgba(255,255,255,0.01)}
.small{font-size:13px;color:var(--muted)}
@media (max-width:900px){.container{grid-template-columns:1fr;padding:8px}.messages{height:56vh}}
</style>
</head>
<body>
<div class="container">
  <div class="panel">
    <div class="header">
      <div>
        <div class="brand">ChatApp</div>
        <div id="status" class="small">დაკავშირება: უცნობი</div>
      </div>
      <div>
        <button id="loginBtn" class="small">შესვლა</button>
        <button id="logoutBtn" class="small" style="display:none">გასვლა</button>
      </div>
    </div>

    <div id="messages" class="messages" aria-live="polite"></div>

    <div class="composer" role="region" aria-label="შეტყობინების შემქმნელი">
      <input id="textInput" class="input" placeholder="დაწერეთ შეტყობინება..." />
      <button id="sendBtn" class="send">გაგზავნა</button>
    </div>
  </div>

  <aside class="panel">
    <h4 style="margin:0 0 8px 0">მომხმარებლები</h4>
    <div id="users" class="users"></div>
    <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)" />
    <div>
      <div class="small">რეგისტრაცია / შესვლა (დემო)</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="nickInput" placeholder="ნიკი" style="flex:1;padding:8px;border-radius:8px;border:0;background:rgba(255,255,255,0.02)" />
        <button id="demoLogin" class="small">შესვლა</button>
      </div>
      <div id="meInfo" style="margin-top:10px" class="small"></div>
    </div>
  </aside>
</div>

<!-- Firebase SDK (modular) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

  // --- REPLACE with your Firebase config ---
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID"
    // storageBucket, messagingSenderId, appId optional
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // App state
  const LS_USER = 'chat_demo_user';
  let currentUser = JSON.parse(localStorage.getItem(LS_USER) || 'null');
  const msgsCol = collection(db, 'chat_messages');
  const q = query(msgsCol, orderBy('createdAt', 'asc'));

  // DOM
  const statusEl = document.getElementById('status');
  const messagesEl = document.getElementById('messages');
  const usersEl = document.getElementById('users');
  const textInput = document.getElementById('textInput');
  const sendBtn = document.getElementById('sendBtn');
  const demoLogin = document.getElementById('demoLogin');
  const nickInput = document.getElementById('nickInput');
  const meInfo = document.getElementById('meInfo');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');

  // Helpers
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function timeStr(ts){ try{ return new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }catch(e){return ''} }
  function renderMessage(m){
    const el = document.createElement('div');
    el.className = 'msg ' + ((currentUser && currentUser.id === m.userId) ? 'me' : 'other');
    el.innerHTML = `<div><strong>${escapeHtml(m.username||'Anon')}</strong></div><div style="margin-top:6px">${escapeHtml(m.text||'')}</div><div class="meta">${timeStr(m.createdAt?.seconds ? m.createdAt.seconds*1000 : (m.createdAt||m.ts)||Date.now())}</div>`;
    messagesEl.appendChild(el);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function setStatus(s){ statusEl.textContent = 'დაკავშირება: ' + s; }

  // Auth (demo local)
  function setCurrentUser(u){
    currentUser = u;
    if(u){
      localStorage.setItem(LS_USER, JSON.stringify(u));
      meInfo.textContent = `შენ: ${u.username}`;
      loginBtn.style.display = 'none';
      logoutBtn.style.display = 'inline-block';
    } else {
      localStorage.removeItem(LS_USER);
      meInfo.textContent = '';
      loginBtn.style.display = 'inline-block';
      logoutBtn.style.display = 'none';
    }
  }
  // init
  setCurrentUser(currentUser);

  // Firestore realtime listener
  let unsubscribe = null;
  try {
    unsubscribe = onSnapshot(q, (snapshot) => {
      messagesEl.innerHTML = '';
      const msgs = [];
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        msgs.push({ id: docSnap.id, ...data });
      });
      // render
      msgs.forEach(renderMessage);
      setStatus('online (Firestore)');
    }, (err) => {
      console.error('onSnapshot error', err);
      setStatus('error');
    });
  } catch (e) {
    console.error('Firestore init error', e);
    setStatus('not connected');
  }

  // Send message
  async function sendMessage(){
    const text = textInput.value.trim();
    if(!text) return;
    const payload = {
      text,
      username: currentUser ? currentUser.username : 'Guest',
      userId: currentUser ? currentUser.id : null,
      createdAt: serverTimestamp(),
      reactions: []
    };
    try {
      await addDoc(msgsCol, payload);
      textInput.value = '';
    } catch (e) {
      console.error('send error', e);
      alert('შეტყობინების გაგზავნა ვერ მოხერხდა');
    }
  }

  sendBtn.addEventListener('click', sendMessage);
  textInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } });

  // Demo login (local only) — creates a simple client identity used for messages
  demoLogin.addEventListener('click', ()=>{
    const nick = (nickInput.value || '').trim();
    if(!nick){ alert('შეიყვანე ნიკი'); return; }
    // create a simple id
    const id = 'u_' + Date.now().toString(36) + Math.random().toString(36).slice(2,6);
    setCurrentUser({ id, username: nick });
    nickInput.value = '';
  });

  // Simple logout
  logoutBtn.addEventListener('click', ()=> setCurrentUser(null));

  // Login button opens demo login input focus
  loginBtn.addEventListener('click', ()=> nickInput.focus());

  // Users list: derive from recent messages (simple)
  // Update users list whenever snapshot changes
  function updateUsersFromSnapshot(snapshot){
    const map = new Map();
    snapshot.forEach(docSnap => {
      const d = docSnap.data();
      if(d && d.userId){
        map.set(d.userId, { id: d.userId, username: d.username });
      }
    });
    usersEl.innerHTML = '';
    for(const u of map.values()){
      const div = document.createElement('div');
      div.className = 'user';
      div.innerHTML = `<div><strong>${escapeHtml(u.username)}</strong></div><div class="small">id:${escapeHtml(u.id)}</div>`;
      usersEl.appendChild(div);
    }
  }

  // Re-attach a snapshot listener that also updates users list
  // (we already have unsubscribe; create a combined listener)
  try {
    // detach previous
    if(typeof unsubscribe === 'function') unsubscribe();
    const q2 = query(msgsCol, orderBy('createdAt', 'asc'));
    const unsub2 = onSnapshot(q2, (snapshot) => {
      messagesEl.innerHTML = '';
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        renderMessage({ id: docSnap.id, ...data });
      });
      updateUsersFromSnapshot(snapshot);
      setStatus('online (Firestore)');
    }, (err) => {
      console.error('onSnapshot error', err);
      setStatus('error');
    });
    // keep reference
    unsubscribe = unsub2;
  } catch(e){
    console.error('listener error', e);
    setStatus('not connected');
  }

  // Optional: expose send for console testing
  window._chat = { sendMessage, db };
</script>
</body>
</html>
